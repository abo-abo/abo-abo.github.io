<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="flattr:id" content="9yl9ry">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <link rel="canonical" href="https://oremacs.com/page34/" />

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/donate/">Donate</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/26/the-little-package-that-could/">
        tiny.el - the little package that could
      </a>
    </h1>

    <span class="post-date">26 Dec 2014</span>

    <h2 id="the-challenge">The Challenge</h2>

<p>It all started with a heated discussion with the author of
<a href="https://github.com/capitaomorte/yasnippet">yasnippet</a> over some minor
nonsense. In the end, we agreed to disagree, but not before he suggested:</p>

<blockquote>
<p>So I hereby challenge you to create this stripped down, no-crap,
version of yasnippet. Dub it &quot; tiny is not yasnippet &quot; after your
grandiose views and in the glorious unix tradition of recursive
acronyms</p>
</blockquote>

<h2 id="the-thought-process">The Thought Process</h2>

<p>Well, doing exactly that would probably be lame, but I really loved
the acronym. Somewhere around that time I saw some post about using
eval-and-replace, i.e. inserting some Elisp in your non-Elisp buffer
and then replacing that code in-place with the result of the eval.</p>

<p>Here&#39;s the type of code that I was playing around with:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nf">mapcar</span>
 <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">x</span> <span class="nv">x</span><span class="p">))</span>
 <span class="p">(</span><span class="nv">number-sequence</span> <span class="mi">1</span> <span class="mi">7</span><span class="p">))</span>
</code></pre></div>
<p>Then I realized that the code should probably produce a string.
Here&#39;s a more refined version:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nf">mapconcat</span>
 <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
   <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;hex: 0x%x&quot;</span>
           <span class="p">(</span><span class="nf">*</span> <span class="nv">x</span> <span class="nv">x</span><span class="p">)))</span>
 <span class="p">(</span><span class="nv">number-sequence</span> <span class="mi">1</span> <span class="mi">7</span><span class="p">)</span>
 <span class="s">&quot;;\n&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Loops are a useful thing to have, they are a blind spot of
<code>yasnippet</code>, and looping is exactly what the code above does.  The
parameters for this loop expansion are:</p>

<ul>
<li>integer range start: <code>1</code></li>
<li>integer range end: <code>7</code></li>
<li>separator to join the expressions: <code>&quot;;\n&quot;</code></li>
<li>Elisp expression to transform the linear range: <code>(* x x)</code></li>
<li><code>format</code> expression for the result: <code>&quot;hex: 0x%x&quot;</code></li>
</ul>

<p>So ideally, in order to have a package called <code>tiny</code>, I&#39;d like to
keep only the parameters and throw away everything else.</p>

<h2 id="the-result">The Result</h2>

<p>Here&#39;s the final result of the shortening, and what <code>tiny-expand</code> would produce:</p>

<ul><li><button type="button" class="btn btn-info" data-toggle="collapse" data-target="#demo-1"><code>m1;\n7*xx|hex: 0x%x</code></button>
<div id="demo-1" class="collapse">
<pre><code>
hex: 0x1;
hex: 0x4;
hex: 0x9;
hex: 0x10;
hex: 0x19;
hex: 0x24;
hex: 0x31
</pre></code>
</div></li></ul>

<p>As you see, it&#39;s pretty compact, with only two characters which are not
actually the parameters of the template:</p>

<ul>
<li><code>m</code> signifies the start of the template. I think this way is much
better than something like having to mark the template body with a
region before expanding. <code>tiny-expand</code> should be called from the end
of the snippet, so there&#39;s no need to mark the end position.</li>
<li><code>|</code> signifies the end of the Elisp expression and the start of the format string.
It can be omitted if your format string starts with a <code>%</code>.</li>
</ul>

<p>Note also the use of shortened Elisp. You can still use the full thing
if you want.  Or just use only the closing parens to resolve the
ambiguities.</p>

<h2 id="the-demos">The Demos</h2>

<p>Here are some more snippets, you can click on them to see what they
expand to. You can also find them and more in the comments section of
the source code:
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-2"> <code>m10</code>
</button> <div id="demo-2" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>0 1 2 3 4 5 6 7 8 9 10
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-3"><code>m5 10</code></button>
<div id="demo-3" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>5 6 7 8 9 10
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-4"><code>m5,10</code></button>
<div id="demo-4" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>5,6,7,8,9,10
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-5"><code>m5 10*xx</code></button>
<div id="demo-5" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>25 36 49 64 81 100
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-6"><code>m5 10*xx%x</code></button>
<div id="demo-6" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>19 24 31 40 51 64
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-7"><code>m5 10*xx|0x%x</code></button>
<div id="demo-7" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>0x19 0x24 0x31 0x40 0x51 0x64
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-8">
<code>m25+x?a%c</code>
</button>
<div id="demo-8" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>a b c d e f g h i j k l m n o p q r s t u v w x y z
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-9">
<code>m25+x?A%c</code>
</button>
<div id="demo-9" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-10">
<code>m97,122(string x)</code>
</button>
<div id="demo-10" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-11">
<code>m97,122stringxx</code>
</button>
<div id="demo-11" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>aa,bb,cc,dd,ee,ff,gg,hh,ii,jj,kk,ll,mm,nn,oo,pp,qq,rr,ss,tt,uu,vv,ww,xx,yy,zz
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-12">
<code>m97,120stringxupcasex</code>
</button>
<div id="demo-12" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>aA,bB,cC,dD,eE,fF,gG,hH,iI,jJ,kK,lL,mM,nN,oO,pP,qQ,rR,sS,tT,uU,vV,wW,xX
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-13">
<code>m97,120stringxupcasex)x</code>
</button>
<div id="demo-13" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>aAa,bBb,cCc,dDd,eEe,fFf,gGg,hHh,iIi,jJj,kKk,lLl,mMm,nNn,oOo,pPp,qQq,rRr,sSs,tTt,uUu,vVv,wWw,xXx
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-14">
<code>m\n10|%(+ x x) and %(* x x) and %s</code>
</button>
<div id="demo-14" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>0 and 0 and 0
2 and 1 and 1
4 and 4 and 2
6 and 9 and 3
8 and 16 and 4
10 and 25 and 5
12 and 36 and 6
14 and 49 and 7
16 and 64 and 8
18 and 81 and 9
20 and 100 and 10
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-15">
<code>m10*2+3x</code>
</button>
<div id="demo-15" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>6 8 10 12 14 16 18 20 22 24 26
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-16">
<code>m\n10expx</code>
</button>
<div id="demo-16" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>1.0
2.718281828459045
7.38905609893065
20.085536923187668
54.598150033144236
148.4131591025766
403.4287934927351
1096.6331584284585
2980.9579870417283
8103.083927575384
22026.465794806718
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-17">
<code>m1\n20expx%014.2f</code>
</button>
<div id="demo-17" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>00000000002.72
00000000007.39
00000000020.09
00000000054.60
00000000148.41
00000000403.43
00000001096.63
00000002980.96
00000008103.08
00000022026.47
00000059874.14
00000162754.79
00000442413.39
00001202604.28
00003269017.37
00008886110.52
00024154952.75
00065659969.14
00178482300.96
00485165195.41
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-18">
<code>m7|%(expt 2 x)</code>
</button>
<div id="demo-18" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>1 2 4 8 16 32 64 128
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-19">
<code>m, 7|0x%02x</code>
</button>
<div id="demo-19" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-20">
<code>m10|%0.2f</code>
</button>
<div id="demo-20" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>0.00 1.00 2.00 3.00 4.00 5.00 6.00 7.00 8.00 9.00 10.00
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-21">
<code>m1\n14|* TODO http://emacsrocks.com/e%02d.html</code>
</button>
<div id="demo-21" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>* TODO http://emacsrocks.com/e01.html
* TODO http://emacsrocks.com/e02.html
* TODO http://emacsrocks.com/e03.html
* TODO http://emacsrocks.com/e04.html
* TODO http://emacsrocks.com/e05.html
* TODO http://emacsrocks.com/e06.html
* TODO http://emacsrocks.com/e07.html
* TODO http://emacsrocks.com/e08.html
* TODO http://emacsrocks.com/e09.html
* TODO http://emacsrocks.com/e10.html
* TODO http://emacsrocks.com/e11.html
* TODO http://emacsrocks.com/e12.html
* TODO http://emacsrocks.com/e13.html
* TODO http://emacsrocks.com/e14.html
</code></pre></div>
<p></div></li>
<li><button type="button" class="btn btn-info"
data-toggle="collapse" data-target="#demo-22">
<code>m\n8|* TODO Wash dog %(+ x 2) \nDEADLINE: &lt;%(date &quot;Jan 1&quot; (* x 5))&gt;</code>
</button>
<div id="demo-22" class="collapse"></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>* TODO Wash dog 2
DEADLINE: &lt;2015-01-01 Thu&gt;
* TODO Wash dog 3
DEADLINE: &lt;2015-01-06 Tue&gt;
* TODO Wash dog 4
DEADLINE: &lt;2015-01-11 Sun&gt;
* TODO Wash dog 5
DEADLINE: &lt;2015-01-16 Fri&gt;
* TODO Wash dog 6
DEADLINE: &lt;2015-01-21 Wed&gt;
* TODO Wash dog 7
DEADLINE: &lt;2015-01-26 Mon&gt;
* TODO Wash dog 8
DEADLINE: &lt;2015-01-31 Sat&gt;
* TODO Wash dog 9
DEADLINE: &lt;2015-02-05 Thu&gt;
* TODO Wash dog 10
DEADLINE: &lt;2015-02-10 Tue&gt;
</code></pre></div>
<p></div></p>

<p>You can expand them one-by-one to see what they do.  As you can see,
Ruby-style interpolation is available in the format string.  There&#39;s
also one special function called <code>date</code> that you can use there.  It
takes the start date as a string (<code>&quot;Jan 1&quot;</code> in the example) and an
integer shift and prints an <code>org</code>-style date.</p>

<h2 id="the-full-syntax">The full syntax</h2>

<p>The full syntax for the snippet is:</p>

<pre style="font-size: 0.6em"><code>m{range start:=0}{separator:= }{range end}{Lisp expr:=indentity}|{format expr:=%d}</code></pre>

<ul>
<li>You always start with <code>m</code>.</li>
<li>Then optional <code>range start</code> that defaults to <code>0</code>.</li>
<li>Then optional <code>separator</code> that defaults to a single space.</li>
<li>Then mandatory <code>range end</code>.</li>
<li>Then optional <code>Lisp expr</code>, that defaults to <code>identity</code>.</li>
<li>Then optional <code>format</code>-style string, that defaults to <code>%d</code>. You have
to separate it with <code>|</code> if the format string does not start with
<code>%</code>. You can also Ruby-style interpolation here, e.g. <code>%(* x x)</code>.</li>
<li>With the point at the end of the snippet, <kbd>M-x</kbd><code>tiny-expand</code>.</li>
</ul>

<h2 id="the-summary">The Summary</h2>

<p>In the end, <a href="https://github.com/abo-abo/tiny">tiny</a> lives up to the name,
implementing only one snippet that can be used in a variety of ways.</p>

<blockquote>
<p>tiny is not yasnippet</p>
</blockquote>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/25/ode-to-toggle/">
        Ode to the toggle
      </a>
    </h1>

    <span class="post-date">25 Dec 2014</span>

    <p>Man, I just love toggles: the light switches, the
<kbd>f</kbd> - full-screen key in <code>vlc</code>, and the clicky pens (ooh, those
are the best). So I try to model some of my Emacs key bindings as
toggles.</p>

<p>Let me just quantify the two features that make a good toggle:</p>

<ul>
<li>only two states: <em>on</em> and <em>off</em></li>
<li>the state is visible at a glance</li>
</ul>

<p>One could argue that with <code>undo</code> most editing commands become toggles.
But they&#39;re not, since each time you call <code>undo</code>, you mess with
Emacs&#39;s undo state. And the undo state isn&#39;t visible at a glance, so
both requirements for a good toggle aren&#39;t fulfilled.</p>

<p>I&#39;ll demonstrate the two editing commands that I use every day,
<code>capitalize-word-toggle</code> and <code>upcase-word-toggle</code>, that are good
toggles.</p>

<h2 id="capitalize-word-toggle"><code>capitalize-word-toggle</code></h2>

<blockquote>
<p>Talk is cheap. Show me the code.</p>
</blockquote>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">char-upcasep</span> <span class="p">(</span><span class="nv">letter</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">eq</span> <span class="nv">letter</span> <span class="p">(</span><span class="nf">upcase</span> <span class="nv">letter</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">capitalize-word-toggle</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">start</span>
         <span class="p">(</span><span class="nf">car</span>
          <span class="p">(</span><span class="k">save-excursion</span>
            <span class="p">(</span><span class="nv">backward-word</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">bounds-of-thing-at-point</span> <span class="ss">&#39;symbol</span><span class="p">)))))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">start</span>
        <span class="p">(</span><span class="k">save-excursion</span>
          <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">start</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">funcall</span>
           <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">char-upcasep</span> <span class="p">(</span><span class="nf">char-after</span><span class="p">))</span>
               <span class="ss">&#39;downcase-region</span>
             <span class="ss">&#39;upcase-region</span><span class="p">)</span>
           <span class="nv">start</span> <span class="p">(</span><span class="nf">1+</span> <span class="nv">start</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">capitalize-word</span> <span class="mi">-1</span><span class="p">))))</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-z&quot;</span><span class="p">)</span> <span class="ss">&#39;capitalize-word-toggle</span><span class="p">)</span>
</code></pre></div>
<p>I may not have mentioned this before, but you should for the most part
ignore the key bindings mentioned on this blog. I&#39;m actually using
them, they work for me because of my non-standard layout, but you
should assign what works for you.</p>

<p>Anyway, <code>capitalize-word-toggle</code> clearly has a state that&#39;s visible at
a glance: the first char of the current symbol. Also, there are only
two possible states: the char can either be upper-case or lower-case.
Hence, I can toggle this state with <kbd>C-z</kbd> for fun and profit.</p>

<p>Maybe some background on how this command is useful for me. I write a bunch of C++,
and the code features a lot of lines like this:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span></span><span class="n">Triangulation</span> <span class="n">triangulation</span><span class="p">;</span> <span class="c1">// duh</span>
</code></pre></div>
<p>So when I&#39;m using <code>auto-complete</code>, it often eagerly expands to
<code>Triangulation</code> when I want <code>triangulation</code>, and the other way around.
So <code>capitalize-word-toggle</code> is super-useful there.</p>

<h2 id="upcase-word-toggle"><code>upcase-word-toggle</code></h2>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">upcase-word-toggle</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bounds</span> <span class="p">(</span><span class="nv">bounds-of-thing-at-point</span> <span class="ss">&#39;symbol</span><span class="p">))</span>
        <span class="nv">beg</span> <span class="nv">end</span>
        <span class="p">(</span><span class="nv">regionp</span>
         <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">this-command</span> <span class="nv">last-command</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">get</span> <span class="nv">this-command</span> <span class="ss">&#39;regionp</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">put</span> <span class="nv">this-command</span> <span class="ss">&#39;regionp</span> <span class="no">nil</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">cond</span>
      <span class="p">((</span><span class="k">or</span> <span class="p">(</span><span class="nv">region-active-p</span><span class="p">)</span> <span class="nv">regionp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">setq</span> <span class="nv">beg</span> <span class="p">(</span><span class="nf">region-beginning</span><span class="p">)</span>
             <span class="nv">end</span> <span class="p">(</span><span class="nf">region-end</span><span class="p">))</span>
       <span class="p">(</span><span class="nf">put</span> <span class="nv">this-command</span> <span class="ss">&#39;regionp</span> <span class="no">t</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">bounds</span>
       <span class="p">(</span><span class="k">setq</span> <span class="nv">beg</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">bounds</span><span class="p">)</span>
             <span class="nv">end</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">bounds</span><span class="p">)))</span>
      <span class="p">(</span><span class="no">t</span>
       <span class="p">(</span><span class="k">setq</span> <span class="nv">beg</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span>
             <span class="nv">end</span> <span class="p">(</span><span class="nf">1+</span> <span class="nv">beg</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">save-excursion</span>
      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">1-</span> <span class="nv">beg</span><span class="p">))</span>
      <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">&quot;[A-Za-z]&quot;</span> <span class="nv">end</span> <span class="no">t</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">funcall</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">char-upcasep</span> <span class="p">(</span><span class="nf">char-before</span><span class="p">))</span>
                        <span class="ss">&#39;downcase-region</span>
                      <span class="ss">&#39;upcase-region</span><span class="p">)</span>
                    <span class="nv">beg</span> <span class="nv">end</span><span class="p">)))))</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-&gt;&quot;</span><span class="p">)</span> <span class="ss">&#39;upcase-word-toggle</span><span class="p">)</span>
</code></pre></div>
<p><code>upcase-word-toggle</code>&#39;s state becomes binary after you call it once,
since initially the thing at point could have mixed case.
But afterwards, it&#39;s either all lowercase or all uppercase.
So again, a clearly visible binary state is a good thing.</p>

<p>This command works either on <code>(bounds-of-thing-at-point &#39;symbol)</code> or
on the active region. Since <code>region-active-p</code> is deactivated after you
call the command once, there&#39;s some machinery to remember the state
and to toggle when called again.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/24/light-it-up/">
        Light it up! Pygments for Emacs Lisp.
      </a>
    </h1>

    <span class="post-date">24 Dec 2014</span>

    <h2 id="the-challenge">The Challenge</h2>

<p>More than 2 years ago, the formidable @bbatsov of <a href="http://emacsredux.com">Emacs Redux</a> had this to say:</p>

<blockquote class="twitter-tweet" lang="en"><p>After so many years pygments (a popular syntax highlighting library used by GitHub &amp; others) still lacks proper support for Emacs Lisp <a href="https://twitter.com/hashtag/fail?src=hash">#fail</a></p>&mdash; Bozhidar Batsov (@bbatsov) <a href="https://twitter.com/bbatsov/status/246929917546221568">September 15, 2012</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Well, let&#39;s turn that #fail-frown upside down!</p>

<h2 id="the-python">The Python</h2>

<p>A quick search brought me to this page:
<a href="http://pygments.org/docs/lexerdevelopment/">Write your own lexer -- Pygments</a>.
Turns out that the Pygments development takes place on
<a href="https://bitbucket.org/birkenfeld/pygments-main">Bitbucket</a>, so I had
to start an account there. I shortly cloned the repository:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>hg clone https://abo-abo@bitbucket.org/birkenfeld/pygments-main
</code></pre></div>
<p>Then I quickly copy-pasted some starting code:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SchemeLexer&#39;</span><span class="p">,</span> <span class="s1">&#39;CommonLispLexer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;HyLexer&#39;</span><span class="p">,</span> <span class="s1">&#39;RacketLexer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;NewLispLexer&#39;</span><span class="p">,</span> <span class="s1">&#39;EmacsLispLexer&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">EmacsLispLexer</span><span class="p">(</span><span class="n">RegexLexer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ELisp lexer, parsing a stream and outputting the tokens</span>
<span class="sd">    needed to highlight elisp code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ELisp&#39;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;emacs&#39;</span><span class="p">,</span> <span class="s1">&#39;elisp&#39;</span><span class="p">]</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*.el&#39;</span><span class="p">]</span>
    <span class="n">mimetypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text/x-elisp&#39;</span><span class="p">]</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>

    <span class="c1"># the rest of the code was copied from CommonLispLexer for now</span>
</code></pre></div>
<p>Apparently, infrastructure-wise, I only need to know two commands.
The first one needs to be run just once, so that Pygments is aware of the new lexer:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ cd ~/git/pygments-main &amp;&amp; make mapfiles
</code></pre></div>
<p>The second command is to (re-)generate <code>/tmp/example.html</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ cp ~/git/emacs/lisp/vc/ediff.el \
  ~/git/pygments-main/tests/examplefiles/
$ ./pygmentize -O full -f html -o /tmp/example.html \
  tests/examplefiles/ediff.el
</code></pre></div>
<p>I would repeat the last line with each update to the code, and then
refresh the page in Firefox to see the result.</p>

<h2 id="the-elisp">The Elisp</h2>

<p>To finalize the lexer, the following tasks ensued:</p>

<ul>
<li>get a list of built-in macros</li>
<li>get a list of special forms</li>
<li>get a list of built-in functions</li>
</ul>

<p>In the process, I&#39;ve added two more lists:</p>

<ul>
<li><p>a list of built-in functions that are highlighted with <code>font-lock-keyword-face</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>&#39;defvaralias&#39;, &#39;provide&#39;, &#39;require&#39;,
&#39;with-no-warnings&#39;, &#39;define-widget&#39;, &#39;with-electric-help&#39;,
&#39;throw&#39;, &#39;defalias&#39;, &#39;featurep&#39;
</code></pre></div></li>
<li><p>a list of built-in functions and macros that are highlighted with <code>font-lock-warning-face</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>&#39;cl-assert&#39;, &#39;cl-check-type&#39;, &#39;error&#39;, &#39;signal&#39;,
&#39;user-error&#39;, &#39;warn&#39;
</code></pre></div></li>
</ul>

<p>To generate the other three lists, I started off writing things in
<code>*scratch*</code>, but after a while my compulsion to <kbd>C-x C-s</kbd>
kicked in and I&#39;ve saved the work to <code>research.el</code>.  At least,
<a href="http://batsov.com/articles/2012/03/08/emacs-tip-number-5-save-buffers-automatically-on-buffer-or-window-switch/">thanks to @bbatsov</a>,
I&#39;m not <kbd>C-x C-s</kbd>-ing that much since I&#39;ve added this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">save-and-switch-buffer</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)</span>
             <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">bound-and-true-p</span> <span class="nv">archive-subfile-mode</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">save-buffer</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">ido-switch-buffer</span><span class="p">))</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="s">&quot;η&quot;</span> <span class="ss">&#39;save-and-switch-buffer</span><span class="p">)</span>
</code></pre></div>
<p>But it&#39;s time for the student to one-up the master, so here&#39;s a tip to
improve even further:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">oleh-ido-setup-hook</span> <span class="p">()</span>
  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">ido-buffer-completion-map</span> <span class="s">&quot;η&quot;</span> <span class="ss">&#39;ido-next-match</span><span class="p">))</span>
</code></pre></div>
<p>This way I can cycle the buffers with the same shortcut that invokes
<code>save-and-switch-buffer</code>. The defaults are <kbd>C-s</kbd> and
<kbd>C-r</kbd>, in case you didn&#39;t know.</p>

<h2 id="the-c">The C</h2>

<p>Getting the list of built-in C functions and special forms, obviously
involved browsing the C source code. In case you don&#39;t (yet) have the Emacs sources,
they&#39;re here:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ git clone git://git.savannah.gnu.org/emacs.git
</code></pre></div>
<p>I switched to the <code>./src</code> directory and called <kbd>M-x</kbd> <code>find-name-dired</code> with
<code>*.c</code> to build a list of all the sources.
Then I ran the following code from <code>research.el</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">defvar</span> <span class="nv">foo-c-functions</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">(</span><span class="k">defvar</span> <span class="nv">foo-c-special-forms</span> <span class="no">nil</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">c-research</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">i</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">files</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">message</span> <span class="s">&quot;%d&quot;</span> <span class="p">(</span><span class="nb">incf</span> <span class="nv">i</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">with-current-buffer</span> <span class="p">(</span><span class="nv">find-file-noselect</span> <span class="nv">file</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
        <span class="p">(</span><span class="k">while</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">&quot;^DEFUN (&quot;</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">backward-char</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">beg</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">end</span> <span class="p">(</span><span class="k">save-excursion</span>
                       <span class="p">(</span><span class="nv">forward-list</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
                <span class="nv">str</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">forward-char</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">search-forward</span> <span class="s">&quot;\&quot;&quot;</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
            <span class="p">(</span><span class="k">setq</span> <span class="nv">str</span> <span class="p">(</span><span class="nf">read</span> <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
                             <span class="p">(</span><span class="nf">+</span> <span class="nv">beg</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">1-</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))))</span>
            <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">&quot;UNEVALLED&quot;</span> <span class="nv">end</span> <span class="no">t</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">push</span> <span class="nv">str</span> <span class="nv">foo-c-special-forms</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">push</span> <span class="nv">str</span> <span class="nv">foo-c-functions</span><span class="p">))))))))</span>
</code></pre></div>
<p>This was beautiful, by the way, to just generate this sort of
documentation from such well-formatted and documented C sources.  Free
Software FTW.</p>

<p>If you&#39;re interested, there are 1294 built-in functions.
Here&#39;s a list of 23 special forms that I found:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="k">and</span> <span class="k">catch</span> <span class="k">cond</span> <span class="k">condition-case</span> <span class="k">defconst</span>
<span class="k">defvar</span> <span class="k">function</span> <span class="k">if</span> <span class="k">interactive</span> <span class="k">let</span> <span class="k">let*</span>
<span class="k">or</span> <span class="k">prog1</span> <span class="k">prog2</span> <span class="k">progn</span> <span class="k">quote</span>
<span class="k">save-current-buffer</span> <span class="k">save-excursion</span>
<span class="k">save-restriction</span> <span class="k">setq</span> <span class="k">setq-default</span>
<span class="k">unwind-protect</span> <span class="k">while</span>
</code></pre></div>
<p>You can read up on the special forms in the
<a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-10.html#%_sec_1.1.3">SICP</a>.
There&#39;s no node for them, so just use isearch.</p>

<h2 id="the-result">The Result</h2>

<p>You can see it here: <a href="/download/ediff.html">ediff.html</a>, as well as on
the rest of the site, since I&#39;ve switched it on everywhere.</p>

<h2 id="the-impact">The Impact</h2>

<p>Unfortunately this won&#39;t have impact on the Github source code
highlighter, since
<a href="http://www.greghendershott.com/2014/11/github-dropped-pygments.html">Github dropped Pygments</a>
recently.</p>

<p>But people that use the static blog generator
<a href="http://jekyllrb.com">Jekyll</a> or the LaTeX package
<a href="http://code.google.com/p/minted">minted</a> (that&#39;s the package that
<code>org-mode</code>&#39;s PDF Export uses by default) will be able to get better
Elisp highlighting. In fact, this blog is already using the new highlighter.</p>

<p>See the rest of projects that use Pygments
<a href="http://pygments.org/faq/#who-uses-pygments">here</a></p>

<h2 id="the-bitbucket">The Bitbucket</h2>

<p>So now, to share the new lexer with the world I just have to learn how to:</p>

<ul>
<li>stage and commit in Mercurial</li>
<li>push Mercurial to Bitbucket</li>
<li>open a pull request on Bitbucket</li>
</ul>

<p>I don&#39;t <em>want</em> to become a <a href="http://xkcd.com/1220/">hipster</a>, these things just happen.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/23/upcase-word-you-silly/">
        upcase-word, you so silly
      </a>
    </h1>

    <span class="post-date">23 Dec 2014</span>

    <p>Do you know what the
<a href="http://ergoemacs.org/emacs/command-frequency.html">most frequently used</a>
Emacs commands are? I can confirm by my own experience that they are
<code>next-line</code> and <code>previous-line</code> (in that order).
So why do <kbd>M-u</kbd> - <code>upcase-word</code>, <kbd>M-l</kbd> - <code>downcase-word</code>, and
<kbd>M-c</kbd> - <code>capitalize-word</code> have such terrible synergy with Emacs&#39;s best commands?</p>

<p>No, <code>upcase-word</code>, this is not what I had in mind:</p>

<table><tbody><tr><td>
<pre style="font-size: 0.6em">
Learn basic key<cursor>s</cursor>troke commands
Overview of Emacs features at gnu.org
</pre>
</td><td>
<kbd>M-u</kbd>
</td><td>
<pre style="font-size: 0.6em">
Learn basic keySTROKE<cursor> </cursor>commands
Overview of Emacs features at gnu.org
</pre>
</td></tr></tbody></table>

<p>If you say:</p>

<blockquote>
<p>But how did you get the cursor in such a crazy position in the first
place? You should have used <kbd>M-b</kbd>/<kbd>M-f</kbd>.</p>
</blockquote>

<p>Well, I got there with <code>previous-line</code> - one of the best Emacs commands!</p>

<h2 id="resolve-the-word-malarkey-with-defadvice">Resolve the <code>*-word</code> malarkey with <code>defadvice</code></h2>

<p>Here are some simple advice commands that I&#39;ve just rolled:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defadvice</span> <span class="nf">upcase-word</span> <span class="p">(</span><span class="nv">before</span> <span class="nv">upcase-word-advice</span> <span class="nv">activate</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">looking-back</span> <span class="s">&quot;\\b&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">backward-word</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defadvice</span> <span class="nf">downcase-word</span> <span class="p">(</span><span class="nv">before</span> <span class="nv">downcase-word-advice</span> <span class="nv">activate</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">looking-back</span> <span class="s">&quot;\\b&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">backward-word</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defadvice</span> <span class="nf">capitalize-word</span> <span class="p">(</span><span class="nv">before</span> <span class="nv">capitalize-word-advice</span> <span class="nv">activate</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">looking-back</span> <span class="s">&quot;\\b&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">backward-word</span><span class="p">)))</span>
</code></pre></div>
<p>Small explanation to the Elisp novices:</p>

<ol>
<li>before <code>upcase-word</code> is called, execute the body of <code>upcase-word-advice</code></li>
<li><code>unless</code> we are at the beginning of the word</li>
<li><code>backward-word</code> once to move to the beginning of the word</li>
</ol>

<p>I&#39;m intentionally not using the newest advice system here, since not everyone
has yet upgraded to Emacs 24.4.
In fact, I saw this gem today at Stack Overflow:</p>

<blockquote>
<p>I am using Emacs 23 and cedet 1.0.1 ...</p>
</blockquote>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/22/sometimes-things-break/">
        Sometimes things break
      </a>
    </h1>

    <span class="post-date">22 Dec 2014</span>

    <p>I was very surprised to find the
<a href="https://github.com/abo-abo/lispy">lispy</a> build broken after I pushed
some minor update, like a change to README.md.  I mean, how in the
world would a few words in README.md break the Elisp tests?  Upon
investigation, it turned out that only one test was broken <sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>.  This
one:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">ert-deftest</span> <span class="nv">clojure-thread-macro</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;cider</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">should</span>
   <span class="p">(</span><span class="nv">string=</span>
    <span class="p">(</span><span class="nv">lispy-with</span>
     <span class="s">&quot;|(map sqr (filter odd? [1 2 3 4 5]))&quot;</span> <span class="s">&quot;2(-&gt;&gt;]&lt;]&lt;]wwlM&quot;</span><span class="p">)</span>
    <span class="s">&quot;(-&gt;&gt; [1 2 3 4 5]\n  (map sqr)\n  (filter odd?))|&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>The culprit was an update in <code>clojure-mode</code>&#39;s indentation.
The previous behavior:</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">]</span>
   <span class="p">(</span><span class="nb">map </span><span class="nv">sqr</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">filter </span><span class="nv">odd?</span><span class="p">))</span>
</code></pre></div>
<p>is now replaced with:</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">]</span>
     <span class="p">(</span><span class="nb">map </span><span class="nv">sqr</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">filter </span><span class="nv">odd?</span><span class="p">))</span>
</code></pre></div>
<p>Thankfully, the <a href="https://travis-ci.com/">Travis CI</a> in combination
with <a href="https://github.com/cask/cask">cask</a> is keeping me up to date.
Apparently, there were some
<a href="https://github.com/clojure-emacs/clojure-mode/issues/265">heated discussions</a>
accompanying the change, and there was some reverting going on.
Anyway, it looks to me that both approaches have merit: the first one
is more logical, since <code>-&gt;&gt;</code> is an operation akin to Elisp&#39;s
<code>with-current-buffer</code>, where the first argument is different from the
others, while the second one is more aesthetically pleasing.  Fine
with me either way, I&#39;m not complaining:)</p>

<p>Also, the key sequence in the test is pretty ancient.  These days I&#39;d
probably use:
<kbd>2(-&gt;&gt;</kbd><kbd>C-f</kbd><kbd>d&lt;j&lt;skwAM</kbd>.  I&#39;ve
recently done a more complex Elisp refactoring screencast, check it
out <a href="https://www.youtube.com/watch?v=Djn6dXzXp_E">here</a>.  Later on, I
plan to do more Emacs-related screencasts (not just <code>lispy</code>-related)
on my <a href="https://www.youtube.com/user/abo5abo/videos">channel</a>.</p>

<p>If you haven&#39;t tried <a href="https://github.com/abo-abo/lispy"><code>lispy</code></a> yet, you&#39;re missing out -
doing this refactor operation feels like you&#39;re doing the 15-number puzzle:</p>

<p><img src="/download/15-puzzle.png" alt="15puzzle"></p>

<p>And that&#39;s fun in my book. But let me get back to the short overview
of the Emacs testing tools that lead me to this post, mainly <code>cask</code>.</p>

<h2 id="cask-what-does-it-do"><code>cask</code>: what does it do?</h2>

<p>According to <a href="http://cask.readthedocs.org/en/latest/">its own documentation</a>:</p>

<blockquote>
<p>Cask is a project management tool for Emacs Lisp to automate the
package development cycle; development, dependencies, testing,
building, packaging and more.</p>
</blockquote>

<p>Yes, please, I&#39;d like to do that! But after the exciting intro
sentence, there&#39;s very little followup documentation-wise.  It took me
ages to figure out how <code>cask</code> can actually give me some tangible
benefits, since I thought that <code>package.el</code> is enough to maintain my
own config (it still is).</p>

<h2 id="tangible-benefits-of-cask">tangible benefits of <code>cask</code></h2>

<p>I&#39;d like to be sure that my packages work across recent Emacs
versions.  I&#39;m using the
<a href="http://savannah.gnu.org/git/?group=emacs">bleeding edge</a> myself, but
people who download my packages from MELPA might be using something
older, like <code>emacs-24.3</code>.</p>

<p>So I want to run my tests on both versions. Also, even for just one
version, the tests need to be run in a minimum environment, i.e. with
only the dependencies loaded, so that my personal configuration does
not interfere with the tests.</p>

<p>This is where <code>cask</code> actually shines: it can bootstrap a whole new
<code>.emacs.d</code>, separate from your own, just for running tests.  It can do
it on your machine as well as on Travis CI.</p>

<p>Here&#39;s my <code>Cask</code> file for <code>lispy</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>(source gnu)
(source melpa)

(package-file &quot;lispy.el&quot;)

(files &quot;*.el&quot; (:exclude &quot;init.el&quot; &quot;lispy-test.el&quot;))

(development
 (depends-on &quot;helm&quot;)
 (depends-on &quot;ace-jump-mode&quot;)
 (depends-on &quot;noflet&quot;)
 (depends-on &quot;iedit&quot;)
 (depends-on &quot;multiple-cursors&quot;)
 (depends-on &quot;cider&quot;)
 (depends-on &quot;slime&quot;)
 (depends-on &quot;geiser&quot;)
 (depends-on &quot;projectile&quot;)
 (depends-on &quot;s&quot;)
 (depends-on &quot;highlight&quot;))
</code></pre></div>
<p>And here&#39;s the <code>Makefile</code>:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span><span class="nv">EMACS</span> <span class="o">=</span> emacs
<span class="c"># EMACS = emacs-24.3</span>

<span class="nv">CASK</span> <span class="o">=</span> ~/.cask/bin/cask
<span class="nv">CASKEMACS</span> <span class="o">=</span> <span class="k">$(</span>CASK<span class="k">)</span> <span class="nb">exec</span> <span class="k">$(</span>EMACS<span class="k">)</span>
<span class="nv">LOAD</span> <span class="o">=</span> -l lispy-inline.el -l lispy.el -l lispy-test.el

<span class="nf">all</span><span class="o">:</span> <span class="n">test</span>

<span class="nf">cask</span><span class="o">:</span>
    <span class="k">$(</span>shell <span class="nv">EMACS</span><span class="o">=</span><span class="k">$(</span>EMACS<span class="k">)</span> <span class="k">$(</span>CASK<span class="k">))</span>

<span class="nf">compile</span><span class="o">:</span>
    <span class="k">$(</span>CASKEMACS<span class="k">)</span> -q  <span class="k">$(</span>LOAD<span class="k">)</span> lispy.el <span class="se">\</span>
    --eval <span class="s2">&quot;(progn (mapc #&#39;byte-compile-file &#39;(\&quot;lispy.el\&quot; \&quot;lispy-inline.el\&quot; \&quot;le-clojure.el\&quot; \&quot;le-scheme.el\&quot; \&quot;le-lisp.el\&quot;)) (switch-to-buffer \&quot;*Compile-Log*\&quot;) (ert t))&quot;</span>

<span class="nf">test</span><span class="o">:</span>
    <span class="k">$(</span>CASKEMACS<span class="k">)</span> -batch <span class="k">$(</span>LOAD<span class="k">)</span> -f ert-run-tests-batch-and-exit

<span class="nf">clean</span><span class="o">:</span>
    rm -f *.elc
</code></pre></div>
<p>As you can see, the <code>Makefile</code> has two separate testing targets: an
interactive one (<code>compile</code>) and a non-interactive one (<code>test</code>).
There&#39;s actually some validity to this, since it happened once that
the same tests we failing in non-interactive mode, but passing in
interactive mode. Also, <code>compile</code> obviously compiles, testing for
compilation warnings/errors.  I can change the Emacs version at the
top, although I don&#39;t have to do it too often.</p>

<p>Finally, here&#39;s <code>.travis.yml</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>language: emacs-lisp
env:
  matrix:
    - EMACS=emacs24

before_install:
  - sudo add-apt-repository -y ppa:cassou/emacs
  - sudo apt-get update -qq
  - sudo apt-get install -qq $EMACS
  - curl -fsSkL --max-time 10 --retry 10 --retry-delay 10 https://raw.github.com/cask/cask/master/go | python

script:
  - make cask
  - make test
</code></pre></div>
<p>So each time I push a change to github, Travis CI will</p>

<ul>
<li>install emacs24</li>
<li>install cask</li>
<li>install the packages from MELPA:

<ul>
<li><code>helm</code></li>
<li><code>ace-jump-mode</code></li>
<li><code>noflet</code></li>
<li><code>iedit</code></li>
<li><code>multiple-cursors</code></li>
<li><code>cider</code></li>
<li><code>slime</code></li>
<li><code>geiser</code></li>
<li><code>projectile</code></li>
<li><code>s</code></li>
<li><code>highlight</code></li>
</ul></li>
<li>load Emacs with these packages</li>
<li>load <code>lispy-test.el</code> and run it</li>
<li>show up green if <code>make test</code> returned <code>0</code></li>
</ul>

<p>Seems a bit wasteful, but it&#39;s <a href="http://xkcd.com/908/">the Cloud</a> - what can you do?</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>upon even further investigation, the test itself was broken for almost a year, since <code>lispy-with-clojure</code> should have been used instead of <code>lispy-with</code>, but <code>cider</code> was changing the indentation of <code>-&gt;&gt;</code> also for <code>emacs-lisp-mode</code>, so things were kind of working out&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page35">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page33">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
