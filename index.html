<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <link rel="canonical" href="https://oremacs.com/" />

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/02/25/warp-9-make-it-so/">
        Make it so&#58 file1 -> Makefile -> file2
      </a>
    </h1>

    <span class="post-date">25 Feb 2017</span>

    <h2 id="intro">Intro</h2>

<p><a href="https://github.com/abo-abo/make-it-so">make-it-so</a> is an old package
of mine that I haven&#39;t yet highlighted on the blog. This package helps
you manage a collection of makefiles that are used to generate new
files from existing files using shell commands.</p>

<p>You can think of these makefiles as a directory of shell functions,
arranged by the extension of the files that they operate on:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ <span class="nb">cd</span> make-it-so <span class="o">&amp;&amp;</span> find recipes -name Makefile
recipes/ipynb/to-md/Makefile
recipes/ogv/crop/Makefile
recipes/ogv/trim/Makefile
recipes/ogv/to-gif/Makefile
recipes/pdf/to-txt/Makefile
recipes/md/to-org/Makefile
recipes/md/to-html/Makefile
recipes/cue/split/Makefile
recipes/dot/to-png/Makefile
recipes/m4a/to-mp3/Makefile
recipes/flac/to-mp3/Makefile
recipes/gif/gifsicle/Makefile
recipes/svg/to-png/Makefile
recipes/chm/to-pdf/Makefile
recipes/txt/encode-utf8/Makefile
recipes/mp4/to-mp3/Makefile
recipes/mp4/trim/Makefile
recipes/mp4/replace-audio/Makefile
recipes/png/to-gif/Makefile
</code></pre></div>
<p>When you call <code>make-it-so</code> on a particular file, you get completion
for the recipes that are available for that file extension, along with
an option to create a new recipe.</p>

<h2 id="example-1-convert-pdf-to-txt">Example 1: convert <code>pdf</code> to <code>txt</code></h2>

<p>Suppose you want to convert a PDF file <code>test.pdf</code> to a text file <code>test.txt</code>.</p>

<p>In case the recipe is in your collection, you don&#39;t have to remember
the command or the command switches to do it anymore:</p>

<ol>
<li>Navigate to <code>test.pdf</code> in <code>dired</code> and press <kbd>,</kbd> (bound to <code>make-it-so</code>).</li>
<li>Select the recipe you want using completion: <code>to-txt</code> is already provided.</li>
<li><p>Your file and the makefile recipe are moved to the staging area:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>./to-txt_test.pdf/test.pdf
./to-txt_test.pdf/Makefile
</code></pre></div></li>
<li><p>The makefile is opened in a new buffer with the following bindings:</p>

<ul>
<li><kbd>f5</kbd> (<code>mis-save-and-compile</code>) will run <code>compile</code>,
creating <code>test.txt</code> in the current directory.</li>
<li><kbd>C-,</kbd> (<code>mis-finalize</code>) will finalize the operation,
moving <code>test.pdf</code> and <code>test.txt</code> to the parent directory (where
<code>test.pdf</code> was before), and deleting the staging directory.</li>
<li><kbd>C-M-,</kbd> (<code>mis-abort</code>) will move <code>test.pdf</code> back to its
initial location and delete all generated files. This command is
effectively an <code>undo</code> for <code>make-it-so</code>.</li>
</ul></li>
</ol>

<p>It takes a large chunk of text to describe everything, but the key sequence for doing all this is quite short:</p>

<ol>
<li><kbd>,</kbd> - <code>make-it-so</code>.</li>
<li><kbd>RET</kbd> - select <code>to-txt</code>.</li>
<li><kbd>f5</kbd> - create <code>test.txt</code>.</li>
<li><kbd>C-,</kbd> - finalize.</li>
</ol>

<h2 id="example-2-make-a-gif-from-a-series-of-png-images">Example 2: make a gif from a series of png images</h2>

<p>I&#39;ll describe the process of creating a high quality gif like this
one, which describes the effect of the <kbd>C</kbd> key
in <a href="https://github.com/abo-abo/lispy">lispy</a>:</p>

<p><img src="/download/lispy-convolute.gif" alt="lispy-convolute"></p>

<p>First, I use <a href="https://launchpad.net/kazam">kazam</a> to take two <code>png</code>
screenshots of my Emacs screen:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ ls -1 *.png
Screenshot <span class="m">2017</span>-02-25 <span class="m">16</span>:14:49.png
Screenshot <span class="m">2017</span>-02-25 <span class="m">16</span>:15:10.png
</code></pre></div>
<p>I plan to use <a href="https://www.lcdf.org/gifsicle/">gifsicle</a> to sequence
the still images into a gif. But it only takes <code>gif</code> as the input
format, so first I have to convert my <code>png</code> files to non-animated
<code>gif</code> files.</p>

<p>I open the <code>dired</code> buffer where they are located and mark them with
<kbd>m</kbd> (<code>dired-mark</code>). Then call <code>make-it-so</code> with <kbd>,</kbd>
and select <code>to-gif</code> recipe.  This recipe has no parameters, so there&#39;s
nothing else to do but <kbd>f5 C-,</kbd>. Two new files are created:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ ls -1 *.png *.gif
Screenshot_2017-02-25 <span class="m">16</span>:14:49.gif
Screenshot_2017-02-25 <span class="m">16</span>:14:49.png
Screenshot_2017-02-25 <span class="m">16</span>:15:10.gif
Screenshot_2017-02-25 <span class="m">16</span>:15:10.png
</code></pre></div>
<p>Note that the file names (the defaults of <code>kazam</code>) are problematic
when used with makefiles, since they contain spaces and colons. The
Elisp layer of <code>make-it-so</code> takes care of that. It renames the files
back and forth so that the logic in the makefiles remains simple.</p>

<p>Next, I mark the two <code>gif</code> files using <kbd>*%</kbd>
(<code>dired-mark-files-regexp</code>), press <kbd>,</kbd> once more and select
the <code>gifsicle</code> recipe. I&#39;m presented a makefile with the following
contents:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span><span class="c"># ——— parameters —————————————————————————————————</span>

<span class="c"># delay between frames in hundredths of a second</span>
<span class="nv">delay</span> <span class="o">=</span> <span class="m">60</span>

<span class="c"># ——— implementation —————————————————————————————</span>
<span class="nv">DIRGIF</span> <span class="o">=</span> <span class="k">$(</span>shell ls *.gif <span class="p">|</span> grep -v anime.gif<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">anime</span>.<span class="n">gif</span>

<span class="nf">anime.gif</span><span class="o">:</span> <span class="n">Makefile</span> <span class="k">$(</span><span class="nv">DIRGIF</span><span class="k">)</span>
    rm -f anime.gif
    gifsicle --delay<span class="o">=</span><span class="k">$(</span>delay<span class="k">)</span> --colors<span class="o">=</span><span class="m">256</span> --loop <span class="k">$(</span>DIRGIF<span class="k">)</span> &gt; <span class="nv">$@</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&gt; provide

<span class="nf">clean</span><span class="o">:</span>
    rm -f anime.gif provide

<span class="nf">install-tools</span><span class="o">:</span>
    sudo apt-get install gifsicle

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">install</span>-<span class="n">tools</span> <span class="n">clean</span>
</code></pre></div>
<p>The most commonly useful parameter, the delay between frames, is
nicely documented at the top. I don&#39;t have to remember that the switch
name is <code>--delay</code> or that the switch style <code>--delay=60</code> is used. I
simply change the number above until I get the result that I want.</p>

<h2 id="example-3-add-a-new-recipe">Example 3: add a new recipe</h2>

<p>As a sample scenario, assume you want to convert *.svg to *.png.</p>

<h3 id="step-1">Step 1</h3>

<p>An internet search leads to <a href="http://stackoverflow.com/questions/9853325/how-to-convert-a-svg-to-a-png-with-image-magick">Stack Overflow</a> and this command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>inkscape -z -e test.png -w 1024 -h 1024 test.svg
</code></pre></div>
<p>Navigate to the file(s) in <code>dired</code> and call <code>make-it-so</code> with
<kbd>,</kbd>.  No default actions are available, so just type &quot;to-png&quot;
and hit <kbd>RET</kbd>.  The &quot;to-&quot; prefix signifies that this is a
conversion, adapting the Makefile to this form:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span><span class="c"># This is a template for the Makefile.</span>
<span class="c"># Parameters should go in the upper half as:</span>
<span class="c">#     width = 200</span>
<span class="c"># and be referenced in the command as $(width)</span>

<span class="c"># ____________________________________________</span>

<span class="nv">DIRSVG</span> <span class="o">=</span> <span class="k">$(</span>shell dir *.svg<span class="k">)</span>

<span class="nv">DIRPNG</span> <span class="o">=</span> <span class="k">$(</span>DIRSVG:.svg<span class="o">=</span>.png<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">clean</span> <span class="n">Makefile</span> <span class="k">$(</span><span class="nv">DIRPNG</span><span class="k">)</span>

<span class="nf">%.png</span><span class="o">:</span> %.<span class="n">svg</span>
    <span class="nb">echo</span> <span class="s2">&quot;add command here&quot;</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&gt; provide

<span class="nf">clean</span><span class="o">:</span>
    rm -f *.png provide

<span class="c"># Insert the install command here.</span>
<span class="c"># e.g. sudo apt-get install ffmpeg</span>
<span class="nf">install-tools</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="s2">&quot;No tools required&quot;</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">install</span>-<span class="n">tools</span> <span class="n">clean</span>
</code></pre></div>
<p>If the action name doesn&#39;t have a &quot;to-&quot; prefix, the transformation is
assumed to be e.g. &quot;svg&quot; -&gt; &quot;out.svg&quot;. You can change this of course
by editing the Makefile.</p>

<h3 id="step-2">Step 2</h3>

<p>In case the command needs additional packages in order to work you
might want to change <code>echo &quot;No tools required&quot;</code> to the appropriate
package install instruction, e.g. <code>sudo apt-get install inkscape</code>.</p>

<p>When you&#39;re on a new system, this will serve as a reminder of what you
should install in order for the Makefile to work. Simply call:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>make install-tools
</code></pre></div>
<h3 id="step-3">Step 3</h3>

<p>Replace <code>echo &quot;add command here&quot;</code> with:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span>    inkscape -z -e <span class="nv">$@</span> -w <span class="k">$(</span>width<span class="k">)</span> -h <span class="k">$(</span>height<span class="k">)</span> $^
</code></pre></div>
<ul>
<li><p>The parameters <code>width</code> and <code>height</code> will go to the top of the
Makefile, where they can be customized.</p></li>
<li><p><code>$@</code> refers to the output file, <code>test.png</code> in this case.</p></li>
<li><p><code>$^</code> refers to the input file, <code>test.svg</code> in this case.</p></li>
</ul>

<p>That&#39;s it. You can see the final
Makefile <a href="https://raw.githubusercontent.com/abo-abo/make-it-so/master/recipes/svg/to-png/Makefile">here</a>.
Test if the command works with <kbd>f5</kbd> from the Makefile.  If
you&#39;re happy with it, call <code>mis-finalize</code> with <kbd>C-,</kbd> from
<code>dired</code>.  The Makefile will be saved for all future calls to
<code>make-it-so</code>.</p>

<h2 id="outro">Outro</h2>

<p>To summarize the advantages of <code>make-it-so</code>:</p>

<ul>
<li>Write the recipe <em>one time</em>, never have to look up how to do the
same thing a few months from now.</li>
<li>A chance to write the recipe <em>zero times</em>, if someone in the
community has already done it and shared the recipe with you.</li>
<li>The Elisp layer takes care of hairy file names.</li>
<li>Parallel commands on multiple files, i.e. <code>make -j8</code>, are provided for free.</li>
</ul>

<p>The most important usage tip: until you&#39;re sure that the command and
the Makefile work properly make backups. In fact, make backups period.
Happy hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/08/28/elf-mode/">
        elf-mode - view the symbol list in a binary
      </a>
    </h1>

    <span class="post-date">28 Aug 2016</span>

    <p>Recently, I&#39;ve been looking at
<a href="http://libigl.github.io/libigl/tutorial/tutorial.html#meshrepresentation">libigl</a>. I
didn&#39;t manage to fully figure out their CMake build system for
tutorials: although each tutorial has a <code>CMakeLists.txt</code>, it&#39;s only
possible to build them all at once.</p>

<p>So I decided to replace <code>CMakeLists.txt</code> with a good-old <code>Makefile</code>;
how hard can it be?  Concerning includes, not at all hard: the missing
files are found with <code>counsel-locate</code> and added to the include path.</p>

<p>But I had some trouble matching a missing <code>ld</code> dependency to a library
file. Fixed it with a bunch of googling and guesswork; I still wonder
if there&#39;s a better way. But in the process, I&#39;ve found this useful
command:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>readelf --syms libGL.so
</code></pre></div>
<p>which produces e.g.:</p>

<pre><small>
Symbol table '.dynsym' contains 2732 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 000000000004faf0     0 SECTION LOCAL  DEFAULT    8
     2: 00000000000e8f20     0 FUNC    GLOBAL DEFAULT   11 glGetIntegerui64i_vNV
     3: 00000000000e13e0     0 FUNC    GLOBAL DEFAULT   11 glGetMultiTexEnvfvEXT
     4: 00000000000d7440     0 FUNC    GLOBAL DEFAULT   11 glProgramUniform2uiv
     5: 00000000000cfdc0     0 FUNC    GLOBAL DEFAULT   11 glMultiTexCoord3sv
</small></pre>

<p>This is a pretty good representation of a binary file: in this
example, instead of one megabyte of gibberish I see a bit more than
2732 lines describing the functions this file uses and provides.</p>

<h2 id="viewing-the-symbol-list-automatically">Viewing the symbol list automatically</h2>

<p>I liked the above representation so much that I want to see it by
default. In Emacs, it&#39;s pretty easy to do with <code>auto-mode-alist</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;auto-mode-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;\\.\\(?:a\\|so\\)\\&#39;&quot;</span> <span class="o">.</span> <span class="nv">elf-mode</span><span class="p">))</span>
</code></pre></div>
<p>The above code instructs Emacs to call <code>elf-mode</code> function whenever
the file name ends in <code>*.a</code> or <code>*.so</code>.</p>

<p>And here&#39;s the body of <code>elf-mode</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defvar-local</span> <span class="nv">elf-mode</span> <span class="no">nil</span><span class="p">)</span>

<span class="c1">;;;###autoload</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">elf-mode</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">inhibit-read-only</span> <span class="no">t</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">elf-mode</span>
        <span class="p">(</span><span class="k">progn</span>
          <span class="p">(</span><span class="nf">delete-region</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">)</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
          <span class="p">(</span><span class="nf">insert-file-contents</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">))</span>
          <span class="p">(</span><span class="k">setq</span> <span class="nv">elf-mode</span> <span class="no">nil</span><span class="p">))</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">elf-mode</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">delete-region</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">)</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nv">shell-command-to-string</span>
               <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;readelf --syms %s&quot;</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">set-buffer-modified-p</span> <span class="no">nil</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">1</span><span class="p">)))</span>
</code></pre></div>
<p>The idea is very simple: <code>elf-mode</code> is a toggle function that replaces
the buffer contents with the shell command output. It carefully uses
<code>read-only-mode</code> and <code>set-buffer-modified-p</code> so that the file will not
be overwritten by accident with the symbol names.</p>

<h2 id="using-autoload-to-avoid-overhead">Using autoload to avoid overhead</h2>

<p>As you might imagine, looking at binaries isn&#39;t really a common
task. Is it worth to be dragging this code around from now on, loading
it on each start? The answer is yes, of course. Since the actual cost
is negligible until the feature is used.</p>

<p>If you look above, <code>elf-mode</code> has an <code>;;;###autoload</code> cookie before
it. The cookie results in this line in my <code>loaddefs.el</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nf">autoload</span> <span class="ss">&#39;elf-mode</span> <span class="s">&quot;modes/ora-elf&quot;</span> <span class="s">&quot;&quot;</span> <span class="no">t</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div>
<p>My <code>init.el</code> always loads <code>loaddefs.el</code>, but never loads <code>ora-elf.el</code>
where the function is defined. That file is only loaded when the
function <code>elf-mode</code> is called for the first time. The above <code>autoload</code>
statement simply instructs Emacs to load a particular file when
<code>elf-mode</code> needs to be called.</p>

<p>When you use the package manager, the autoloads file is generated and
loaded for you automatically:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ tree elpa/ace-link-20160811.112/

elpa/ace-link-20160811.112/
├── ace-link-autoloads.el
├── ace-link.el
├── ace-link.elc
└── ace-link-pkg.el

<span class="m">0</span> directories, <span class="m">4</span> files
</code></pre></div>
<p>Here, the package manager will always load <code>ace-link-autoloads.el</code>,
which instructs Emacs to load <code>ace-link.el</code> when one of the
<code>;;;###autoload</code> functions is called and <code>ace-link.el</code> isn&#39;t yet
loaded.</p>

<p>As an example of how useful delayed loading is: my 6000 line
<a href="https://github.com/abo-abo/oremacs">config</a> starts in 1.8 seconds.
About 40% of that time is spent on <code>(package-initialize)</code>, which I
assume is the package manager loading all those <code>*-autoloads.el</code> files
that I have in my <code>elpa/</code>.</p>

<h2 id="outro">Outro</h2>

<p>Let me know if there&#39;s interest to have <code>elf-mode</code> on MELPA.  Also, if
anyone knows how to set mode automatically based on the first few
chars of the file (all binaries seem to start with <code>^?ELF</code>), I&#39;d like
to know that as well. Happy hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/07/29/brand-new-swiper-all/">
        Swipe all the files!
      </a>
    </h1>

    <span class="post-date">29 Jul 2016</span>

    <p>If you&#39;ve ever tried the <code>swiper-all</code> from
<a href="https://github.com/abo-abo/swiper">swiper</a>, forget everything about
it.  The command was super-awkward, since it had to parse all your
open files before giving you a chance enter anything, resulting in
dozens of seconds before the prompt.</p>

<p>Recently, I&#39;ve had some time to examine and improve it and the result
looks very promising. The new command is now async, which means
there&#39;s no delay before the prompt comes up. Here&#39;s a result I got
with no delay while having around 50 buffers open:</p>

<p><img src="/download/swiper-all.png" alt="swiper-all.png"></p>

<p>The shortcut I&#39;m using:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c u&quot;</span><span class="p">)</span> <span class="ss">&#39;swiper-all</span><span class="p">)</span>
</code></pre></div>
<p>For efficiency&#39;s sake a small trade off had to be made: the line
numbers are no longer displayed. This actually results in an advantage
that you can select different candidates on the same line.</p>

<p>There are still a few things I plan to try for the new command, like
adding file-less buffers, caching for incremental regexes and maybe
even newlines in wild cards, but even now it seems very usable. So
give it a try, enjoy and happy hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/06/27/ivy-push-view/">
        Bookmark the current window layout with Ivy
      </a>
    </h1>

    <span class="post-date">27 Jun 2016</span>

    <p>Today&#39;s post is about the newest feature related to the
<a href="https://github.com/abo-abo/swiper">ivy-switch-buffer</a> command. If you
use <code>ivy-mode</code>, you&#39;re probably already using <code>ivy-switch-buffer</code>
since it overwrites the built-in <code>switch-to-buffer</code>.</p>

<p>The cool thing about <code>ivy-switch-buffer</code> is that it&#39;s not only buffers
that are offered for completion. Other buffer-like entities can be
there as well: bookmarks, recently opened files (<code>recentf</code>), and
finally, window layouts. Since all of those are relatively the same
concept, it&#39;s very convenient to have them all in one place available
for completion.</p>

<p>Here are the relevant settings:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="c1">;; Enable bookmarks and recentf</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-use-virtual-buffers</span> <span class="no">t</span><span class="p">)</span>

<span class="c1">;; Example setting for ivy-views</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-views</span>
      <span class="o">`</span><span class="p">((</span><span class="s">&quot;dutch + notes {}&quot;</span>
         <span class="p">(</span><span class="nv">vert</span>
          <span class="p">(</span><span class="nv">file</span> <span class="s">&quot;dutch.org&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">buffer</span> <span class="s">&quot;notes&quot;</span><span class="p">)))</span>
        <span class="p">(</span><span class="s">&quot;ivy.el {}&quot;</span>
         <span class="p">(</span><span class="nv">horz</span>
          <span class="p">(</span><span class="nv">file</span> <span class="o">,</span><span class="p">(</span><span class="nv">find-library-name</span> <span class="s">&quot;ivy&quot;</span><span class="p">))</span>
          <span class="p">(</span><span class="nv">buffer</span> <span class="s">&quot;*scratch*&quot;</span><span class="p">)))))</span>
</code></pre></div>
<p>I did mention <code>ivy-views</code> before in the
<a href="http://oremacs.com/2016/04/26/ivy-0.8.0/">ivy-0.8.0 release</a> post.
But now, instead of setting <code>ivy-views</code> by hand, you can also bind
<code>ivy-push-view</code> to a key and store as many window configurations as
you like, really fast. </p>

<p>What gets stored:</p>

<ul>
<li>The window list - all windows open on the current frame.</li>
<li>The window splits relative to each other as a tree. Currently, the
size of the split isn&#39;t saved, all windows are split equally.</li>
<li>The point positions in each window. If you use just one window,
you&#39;ve got something similar to <code>bookmark-set</code>.</li>
</ul>

<h2 id="recommended-key-bindings">Recommended key bindings</h2>

<p>Here&#39;s what I use currently:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c v&quot;</span><span class="p">)</span> <span class="ss">&#39;ivy-push-view</span><span class="p">)</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c V&quot;</span><span class="p">)</span> <span class="ss">&#39;ivy-pop-view</span><span class="p">)</span>
</code></pre></div>
<h2 id="typical-workflow">Typical workflow</h2>

<p>Suppose I have two files open: the file <code>2016-06-23-ivy-push-view.md</code>
and the <code>_posts</code> directory. By pressing <kbd>C-c v</kbd> I am prompted
for a view name with the default being e.g. 
<code>{} 2016-06-23-ivy-push-view.md _posts 2</code>.</p>

<p>I can still name the view however I want, but I typically just press
<kbd>RET</kbd>.  The parts of the automatic view name are:</p>

<ul>
<li><code>{}</code> - this is a simple string marker to distinguish the views in
the buffer view. If I enter only <code>{}</code> into <code>ivy-switch-buffer</code>
prompt, the candidates will normally filter to only views, since
very rarely will a file or a buffer name match <code>{}</code>.</li>
<li><code>2016-06-23-ivy-push-view.md _posts</code> is the list of buffers stored
in the view. This view has only two buffers, but <code>ivy-push-view</code> can
handle as many windows as you can cram into a single frame.</li>
<li><code>2</code> means that I already have two views with the same buffers, each
new view with the same buffers gets an increased number for the
suggested name. And it&#39;s not useless to have many views for the same
buffers, since the views also store point positions, not just the
window list.</li>
</ul>

<p>Here&#39;s the beauty of it for me: when I type <code>_posts</code> into
<code>ivy-switch-buffer</code> I can chose to open the <code>_posts</code> directory in a
variety of ways:</p>

<ul>
<li>If the buffer is currently open, I can just switch there.</li>
<li>If the buffer is currently closed, I can re-open it, thanks to <code>recentf</code>.</li>
<li>I can open the buffer as part of a stored view(s) in <code>ivy-views</code>.</li>
</ul>

<p>Finally, if I decide that I don&#39;t need a particular view any more, I
can delete it with <kbd>C-c V</kbd> (<code>ivy-pop-view</code>). It&#39;s possible to
delete many views at once by pressing <kbd>C-M-m</kbd> (<code>ivy-call</code>),
as usual with most <code>ivy</code> completion functions.</p>

<h2 id="breaking-api-change">Breaking API change</h2>

<p>While implementing <code>ivy-set-view</code> I decided that the current way alist
collections are handled together with actions is sub-optimal.  Here&#39;s
the new way of working:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">res</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ivy-with</span>
   <span class="o">&#39;</span><span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;test: &quot;</span>
     <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;one&quot;</span> <span class="o">.</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;three&quot;</span> <span class="o">.</span> <span class="mi">3</span><span class="p">))</span>
     <span class="nb">:action</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">res</span> <span class="nv">x</span><span class="p">)))</span>
   <span class="s">&quot;t C-m&quot;</span><span class="p">)</span>
  <span class="nv">res</span><span class="p">)</span>
<span class="c1">;; =&gt;</span>
<span class="c1">;; (&quot;three&quot; . 3)</span>
</code></pre></div>
<p>Previously, the return result would be <code>3</code>, i.e. the <code>cdr</code> of the
selected candidate. Any code using <code>ivy-read</code> with an alist-type
collection will break. I fixed all instances in <code>counsel.el</code>, and
there actually aren&#39;t too many uses in the published third party
packages.</p>

<p>A simple fix to the problem is to use <code>cdr</code> in the action function.
Additionally, having more information available in the action function
will serve to improve the code.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/06/06/counsel-set-variable/">
        Set an Emacs variable with double completion
      </a>
    </h1>

    <span class="post-date">06 Jun 2016</span>

    <p>I&#39;d like to show off a certain Elisp productivity booster that I&#39;ve
had in an unfinished state for a while and finished just today.  </p>

<p>A large part of tweaking Elisp is simply setting variables. The new
command, <a href="https://github.com/abo-abo/swiper">counsel-set-variable</a>,
allows to set them quite a bit faster.</p>

<h2 id="completion-stage-1">Completion stage 1:</h2>

<p>First of all, you get completion for all variables that you have defined:</p>

<p><img src="/download/counsel-set-variable-1.png" alt="counsel-set-variable-1.png"></p>

<h2 id="completion-stage-2">Completion stage 2:</h2>

<p>Once a symbol is selected, the code checks whether the symbol is a
<code>defcustom</code> with type <code>&#39;boolean</code> or <code>&#39;radio</code>. Since then it is
possible to offer all values that the symbol is allowed to become for
completion.</p>

<p>For example, here&#39;s a typical <code>&#39;radio</code>-type definition:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defcustom</span> <span class="nv">avy-style</span> <span class="ss">&#39;at-full</span>
  <span class="s">&quot;The default method of displaying the overlays.</span>
<span class="s">Use </span><span class="ss">`avy-styles-alist&#39;</span><span class="s"> to customize this per-command.&quot;</span>
  <span class="nb">:type</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">choice</span>
          <span class="p">(</span><span class="nv">const</span> <span class="nb">:tag</span> <span class="s">&quot;Pre&quot;</span> <span class="nv">pre</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">const</span> <span class="nb">:tag</span> <span class="s">&quot;At&quot;</span> <span class="nv">at</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">const</span> <span class="nb">:tag</span> <span class="s">&quot;At Full&quot;</span> <span class="nv">at-full</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">const</span> <span class="nb">:tag</span> <span class="s">&quot;Post&quot;</span> <span class="nv">post</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">const</span> <span class="nb">:tag</span> <span class="s">&quot;De Bruijn&quot;</span> <span class="nv">de-bruijn</span><span class="p">)))</span>
</code></pre></div>
<p>And here&#39;s a completion screen offered for this variable:</p>

<p><img src="/download/counsel-set-variable-2.png" alt="counsel-set-variable-2.png"></p>

<p>It is worth noting that the current value of the variable is
pre-selected, to give a nice reference point for the new setting.</p>

<h3 id="in-case-the-symbol-isn-39-t-a-boolean-or-a-radio">In case the symbol isn&#39;t a boolean or a radio</h3>

<p>Then you get a completion session similar to <kbd>M-x</kbd>
<code>read-expression</code>, but with the initial contents already filled
in. For example:</p>

<p><img src="/download/counsel-set-variable-3.png" alt="counsel-set-variable-3.png"></p>

<p>The <code>read-expression</code> part combines well with this setting in my config:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">conditionally-enable-lispy</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">this-command</span> <span class="ss">&#39;eval-expression</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">lispy-mode</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">add-hook</span>
 <span class="ss">&#39;minibuffer-setup-hook</span>
 <span class="ss">&#39;conditionally-enable-lispy</span><span class="p">)</span>
</code></pre></div>
<p>Here&#39;s a series of commands using
<a href="https://github.com/abo-abo/lispy">lispy-mode</a> that I would typically
use for the screenshot above, to set <code>ivy-re-builders-alist</code> to a new
value:</p>

<ol>
<li><kbd>C-f</kbd> (<code>forward-char</code>) to get into special.</li>
<li><kbd>-e</kbd> (<code>lispy-ace-subword</code>) to mark the <code>plus</code> part of the code.</li>
<li><kbd>C-d</kbd> (<code>lispy-delete</code>) to delete the active region.</li>
</ol>

<p>After the <kbd>C-f -e C-d</kbd> chain of bindings, the minibuffer contents become:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-re-builders-alist</span> <span class="o">&#39;</span><span class="p">((</span><span class="no">t</span> <span class="o">.</span> <span class="nv">ivy--regex-|</span><span class="p">)))</span>
</code></pre></div>
<p>I press <kbd>C-M-i</kbd> (<code>completion-at-point</code>) to get completion for
all symbols that start with <code>ivy--regex-</code>. Since I have <code>ivy-mode</code> on,
<kbd>C-M-i</kbd> starts a recursive completion session. I highly
recommend adding these settings to your config:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="c1">;; Allow to read from minibuffer while in minibuffer.</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">enable-recursive-minibuffers</span> <span class="no">t</span><span class="p">)</span>

<span class="c1">;; Show the minibuffer depth (when larger than 1)</span>
<span class="p">(</span><span class="nv">minibuffer-depth-indicate-mode</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>Finally, I would e.g. select e.g. <code>ivy--regex-fuzzy</code> and <kbd>RET
RET</kbd> to finalize the eval. The first <kbd>RET</kbd> exits from
<code>completion-at-point</code> and the second <kbd>RET</kbd> exits from
<code>counsel-set-variable</code>.</p>

<h2 id="outro">Outro</h2>

<p>I think this command, especially the newly added <code>read-expression</code>
part, is quite a bit faster than what I did before. That is switching
to <code>*scratch*</code> and typing in the <code>setq</code> manually and evaluating with
<kbd>C-j</kbd>. Here&#39;s my binding for the new command:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;&lt;f2&gt; j&quot;</span><span class="p">)</span> <span class="ss">&#39;counsel-set-variable</span><span class="p">)</span>
</code></pre></div>
<p>It&#39;s not very mnemonic, but it&#39;s really fast. Just a suggestion, in
case you don&#39;t know where to bind it. Happy hacking!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
