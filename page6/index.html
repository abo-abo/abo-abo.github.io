<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <link rel="canonical" href="https://oremacs.com/page6/" />

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/09/04/ivy-fancy-minibuffer/">
        Fancy minibuffer faces for Ivy completion
      </a>
    </h1>

    <span class="post-date">04 Sep 2015</span>

    <p>Today, I&#39;ll describe a recent improvement to the display of Ivy completion.
To use it, add this code to your configuration:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-display-style</span> <span class="ss">&#39;fancy</span><span class="p">)</span>
</code></pre></div>
<p>After this, <a href="https://github.com/abo-abo/swiper">swiper</a> will look like this:</p>

<p><img src="/download/ivy-display-style-1.png" alt="ivy-display-style-1.png"></p>

<p>And <code>counsel-M-x</code> will look like this:</p>

<p><img src="/download/ivy-display-style-2.png" alt="ivy-display-style-2.png"></p>

<p>If you haven&#39;t used it before, <code>counsel-M-x</code> is part the counsel
package on MELPA, or part of swiper package if you&#39;re installing from
GNU ELPA. Basically, it&#39;s a <kbd>M-x</kbd> replacement (that I like to
bind to <kbd>C-t</kbd> for efficiency reasons), that doubles as
<code>find-function</code> (just press <kbd>C-.</kbd> instead of <kbd>RET</kbd>
to find the function instead of calling it). If you&#39;re using
<code>counsel-M-x</code> I highly recommend to also install <code>smex</code>, since then
<code>counsel-M-x</code> will use <code>smex</code> for sorting the matched commands.</p>

<p>The update will propertize the minibuffer contents with a new set of faces:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defcustom</span> <span class="nv">swiper-minibuffer-faces</span>
  <span class="o">&#39;</span><span class="p">(</span><span class="nv">swiper-minibuffer-match-face-1</span>
    <span class="nv">swiper-minibuffer-match-face-2</span>
    <span class="nv">swiper-minibuffer-match-face-3</span>
    <span class="nv">swiper-minibuffer-match-face-4</span><span class="p">)</span>
  <span class="s">&quot;List of </span><span class="ss">`swiper&#39;</span><span class="s"> faces for minibuffer group matches.&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Initially, when responding to
<a href="https://github.com/abo-abo/swiper/issues/212">#212</a>, I used the
original swiper faces in the minibuffer as well. But after some use,
their brightness became a bit annoying.  So I introduced a new set of
faces that can be customized separately.</p>

<p>Here are the settings that I&#39;m currently using:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">custom-set-faces</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="nv">swiper-minibuffer-match-face-1</span>
   <span class="p">((</span><span class="no">t</span> <span class="nb">:background</span> <span class="s">&quot;#dddddd&quot;</span><span class="p">)))</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="nv">swiper-minibuffer-match-face-2</span>
   <span class="p">((</span><span class="no">t</span> <span class="nb">:background</span> <span class="s">&quot;#bbbbbb&quot;</span> <span class="nb">:weight</span> <span class="nv">bold</span><span class="p">)))</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="nv">swiper-minibuffer-match-face-3</span>
   <span class="p">((</span><span class="no">t</span> <span class="nb">:background</span> <span class="s">&quot;#bbbbff&quot;</span> <span class="nb">:weight</span> <span class="nv">bold</span><span class="p">)))</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="nv">swiper-minibuffer-match-face-4</span>
   <span class="p">((</span><span class="no">t</span> <span class="nb">:background</span> <span class="s">&quot;#ffbbff&quot;</span> <span class="nb">:weight</span> <span class="nv">bold</span><span class="p">))))</span>
</code></pre></div>
<p>It&#39;s similar to what the Firefox address bar uses: gray background and
bold font. Additionally, the matching parts are highlighted with pale
gray, blue and magenta colors. If you like the color scheme, it&#39;s part
of <a href="https://github.com/abo-abo/eclipse-theme">eclipse-theme</a>.  Another
choice, for even less distraction, could be to remove the background
from these faces, only leaving the bold part on the matches.</p>

<p>Thanks to <a href="https://github.com/Wilfred">@Wilfred</a> for nudging me to
finally implement this feature.  It&#39;s been on my list for a long time,
but I&#39;ve been putting it off.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/26/counsel-jedi/">
        Complete Python symbols using Ivy
      </a>
    </h1>

    <span class="post-date">26 Aug 2015</span>

    <p>I had a fascination with Python at one point, until I got too annoyed
with the indentation rules.  I still have a few scripts left over, so
I&#39;m sympathetic to Python support in Emacs.  The reason for
today&#39;s post comes from
<a href="http://emacs.stackexchange.com/questions/15032/insert-parens-while-completing-functions-in-company-mode">this question</a>
on Emacs StackExchange. Essentially, the user wants to insert parens
automatically when a function name is completed.</p>

<p>The completion candidates come from
<a href="https://github.com/tkf/emacs-jedi">jedi</a> plugin.  To quickly see
where the list of strings is coming from, I&#39;ve examined <code>ac-sources</code>
variable and saw that it contains <code>ac-source-jedi-direct</code>, which evaluates to:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">((</span><span class="nv">candidates</span> <span class="o">.</span> <span class="nv">jedi:ac-direct-matches</span><span class="p">)</span>
 <span class="p">(</span><span class="nv">prefix</span> <span class="o">.</span> <span class="nv">jedi:ac-direct-prefix</span><span class="p">)</span>
 <span class="p">(</span><span class="nv">init</span> <span class="o">.</span> <span class="nv">jedi:complete-request</span><span class="p">)</span>
 <span class="p">(</span><span class="nv">requires</span> <span class="o">.</span> <span class="mi">-1</span><span class="p">))</span>
</code></pre></div>
<p>This means that <code>jedi:complete-request</code> has to be called at point,
followed by <code>jedi:ac-direct-matches</code> to obtain the list of strings. So
basically, this code:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nv">deferred:sync!</span>
   <span class="p">(</span><span class="nv">jedi:complete-request</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">jedi:ac-direct-matches</span><span class="p">))</span>
</code></pre></div>
<p>Note the call to <code>deferred:sync!</code>. I had to add that one to make sure
that <code>jedi:complete-request</code> completes before <code>jedi:ac-direct-matches</code>
is called.</p>

<p>Testing with some Python code, where <code>|</code> is the point:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span><span class="s2">&quot;bar&quot;</span><span class="p">}</span>
<span class="n">params</span><span class="o">.</span><span class="n">i</span>
</code></pre></div>
<p>The Elisp code above will return:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="o">#(</span><span class="s">&quot;items&quot;</span>
   <span class="mi">0</span> <span class="mi">5</span> <span class="p">(</span><span class="nv">summary</span>
        <span class="s">&quot;function: __builtin__.dict.items&quot;</span>
        <span class="nv">symbol</span>
        <span class="s">&quot;f&quot;</span>
        <span class="nv">document</span>
        <span class="s">&quot;items(self)</span>

<span class="s">D.items() -&gt; list of D&#39;s (key, value) pairs, as 2-tuples&quot;</span><span class="p">))</span>
  <span class="o">#(</span><span class="s">&quot;iteritems&quot;</span>
    <span class="mi">0</span> <span class="mi">9</span> <span class="p">(</span><span class="nv">summary</span>
         <span class="s">&quot;function: __builtin__.dict.iteritems&quot;</span>
         <span class="nv">symbol</span>
         <span class="s">&quot;f&quot;</span>
         <span class="nv">document</span>
         <span class="s">&quot;iteritems(self)</span>

<span class="s">D.iteritems() -&gt; an iterator over the (key, value) items of D&quot;</span><span class="p">))</span>
  <span class="o">#(</span><span class="s">&quot;iterkeys&quot;</span>
    <span class="mi">0</span> <span class="mi">8</span> <span class="p">(</span><span class="nv">summary</span>
         <span class="s">&quot;function: __builtin__.dict.iterkeys&quot;</span>
         <span class="nv">symbol</span>
         <span class="s">&quot;f&quot;</span>
         <span class="nv">document</span>
         <span class="s">&quot;iterkeys(self)</span>

<span class="s">D.iterkeys() -&gt; an iterator over the keys of D&quot;</span><span class="p">))</span>
  <span class="o">#(</span><span class="s">&quot;itervalues&quot;</span>
    <span class="mi">0</span> <span class="mi">10</span> <span class="p">(</span><span class="nv">summary</span>
          <span class="s">&quot;function: __builtin__.dict.itervalues&quot;</span>
          <span class="nv">symbol</span>
          <span class="s">&quot;f&quot;</span>
          <span class="nv">document</span>
          <span class="s">&quot;itervalues(self)</span>

<span class="s">D.itervalues() -&gt; an iterator over the values of D&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>So these strings come with the symbol documentation and symbol type
encoded as string properties. After this, the rest of the Elisp code
follows very easily, you can find it as part of
<a href="https://github.com/abo-abo/swiper/blob/master/counsel.el">counsel</a>
package on MELPA:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-jedi</span> <span class="p">()</span>
  <span class="s">&quot;Python completion at point.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bnd</span> <span class="p">(</span><span class="nv">bounds-of-thing-at-point</span> <span class="ss">&#39;symbol</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">bnd</span>
        <span class="p">(</span><span class="k">progn</span>
          <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-beg</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">bnd</span><span class="p">))</span>
          <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-end</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">bnd</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-beg</span> <span class="no">nil</span><span class="p">)</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-end</span> <span class="no">nil</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">deferred:sync!</span>
   <span class="p">(</span><span class="nv">jedi:complete-request</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;Symbol name: &quot;</span> <span class="p">(</span><span class="nv">jedi:ac-direct-matches</span><span class="p">)</span>
            <span class="nb">:action</span> <span class="nf">#&#39;</span><span class="nv">counsel--py-action</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel--py-action</span> <span class="p">(</span><span class="nv">symbol</span><span class="p">)</span>
  <span class="s">&quot;Insert SYMBOL, erasing the previous one.&quot;</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">stringp</span> <span class="nv">symbol</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">with-ivy-window</span>
      <span class="p">(</span><span class="nb">when</span> <span class="nv">counsel-completion-beg</span>
        <span class="p">(</span><span class="nf">delete-region</span>
         <span class="nv">counsel-completion-beg</span>
         <span class="nv">counsel-completion-end</span><span class="p">))</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-beg</span>
            <span class="p">(</span><span class="nv">move-marker</span> <span class="p">(</span><span class="nf">make-marker</span><span class="p">)</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">insert</span> <span class="nv">symbol</span><span class="p">)</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-end</span>
            <span class="p">(</span><span class="nv">move-marker</span> <span class="p">(</span><span class="nf">make-marker</span><span class="p">)</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">equal</span> <span class="p">(</span><span class="nf">get-text-property</span> <span class="mi">0</span> <span class="ss">&#39;symbol</span> <span class="nv">symbol</span><span class="p">)</span> <span class="s">&quot;f&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">insert</span> <span class="s">&quot;()&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="k">setq</span> <span class="nv">counsel-completion-end</span>
              <span class="p">(</span><span class="nv">move-marker</span> <span class="p">(</span><span class="nf">make-marker</span><span class="p">)</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">backward-char</span> <span class="mi">1</span><span class="p">)))))</span>
</code></pre></div>
<p>Essentially, the last interesting part is <code>(equal (get-text-property 0
&#39;symbol symbol) &quot;f&quot;)</code> which test if the string corresponds to a
function or not. The rest of the code just fiddles with symbol markers
with ensure that the previous symbol is erased before the new symbol
is inserted if you press <kbd>C-M-n</kbd> (<code>ivy-next-line-and-call</code>),
or use <code>ivy-resume</code>. Just to describe how this would be useful for the
Python code above: I call <code>counsel-jedi</code>, followed by <kbd>C-M-n</kbd>
to get:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span><span class="s2">&quot;bar&quot;</span><span class="p">}</span>
<span class="n">params</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="o">|</span><span class="p">)</span>
</code></pre></div>
<p>Pressing <kbd>C-M-n</kbd> again will result in:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span><span class="s2">&quot;bar&quot;</span><span class="p">}</span>
<span class="n">params</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="o">|</span><span class="p">)</span>
</code></pre></div>
<p>Once I&#39;m satisfied with my selected candidate, I can press either
<kbd>C-m</kbd> or <kbd>C-j</kbd> or <kbd>C-g</kbd>.  Most of the above
code can be used almost verbatim if you&#39;re a Helm fan and want to
implement <code>helm-jedi</code>. Basically, the approach I described (going
through <code>ac-sources</code>) can be used to implement alternative completion
in a lot of cases where <code>auto-complete-mode</code> completion is already
available.</p>

<p>Finally, if you like the idea of auto-inserting parens with completion
and are using C/C++, have a look at
<a href="https://github.com/abo-abo/function-args">function-args</a> - this
package does that too, with Ivy, Ido and Helm as available back ends.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/14/ivy-kill-ring-save/">
        Store all current ivy candidates into the kill ring
      </a>
    </h1>

    <span class="post-date">14 Aug 2015</span>

    <p>I&#39;d like to highlight a new command added to
<a href="https://github.com/abo-abo/swiper">ivy-mode</a> today:
<code>ivy-kill-ring-save</code>.  It allows to store all current candidates to
the kill ring. This could have a number of uses.</p>

<h2 id="scenario-1">Scenario 1</h2>

<p>Suppose you want to learn some Elisp, specifically all functions that
start with <code>forward-</code>. Then call <code>counsel-describe-function</code> with
&quot;forward-&quot; as input and press <kbd>M-w</kbd>. Then just yank this into
some buffer, <code>org-mode</code> for instance, and go through the functions
one-by-one takings notes on the way:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>forward-comment
forward-paragraph
forward-thing
forward-symbol
forward-visible-line
forward-word
forward-same-syntax
forward-whitespace
forward-button
forward-line
forward-list
forward-sentence
forward-point
forward-to-indentation
forward-ifdef
forward-char
forward-sexp
forward-page
</code></pre></div>
<h2 id="scenario-2">Scenario 2</h2>

<p>Suppose you want to store a subset of <code>projectile-find-file</code> names
that match a pattern.  Just press <kbd>M-w</kbd> and those file names
will be on the top of the kill ring. Of course, you need to have this setting on:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">setq</span> <span class="nv">projectile-completion-system</span> <span class="ss">&#39;ivy</span><span class="p">)</span>
</code></pre></div>
<p>This scenario should apply to basically any place where you&#39;re
completing file names, like <code>counsel-locate</code> or
<code>counsel-find-file</code>. Also
<a href="https://github.com/technomancy/find-file-in-project">find-file-in-project</a>,
which uses <code>ivy</code> for completion if it&#39;s installed.</p>

<h2 id="outro">Outro</h2>

<p>Note also that the command comes for free, since normally nothing is
done by <kbd>M-w</kbd> when the region isn&#39;t active. When the region
is active, this command will store the selected text instead of
matched candidates.</p>

<p>Thanks to <a href="https://github.com/drorbemet">@drorbemet</a> for giving me the
idea in <a href="https://github.com/abo-abo/swiper/issues/197">#197</a>.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/05/swiper-0.6.0/">
        Ivy-mode 0.6.0 is out
      </a>
    </h1>

    <span class="post-date">05 Aug 2015</span>

    <p>For those who don&#39;t keep up,
<a href="https://github.com/abo-abo/swiper">ivy-mode</a> is a completion method
that&#39;s similar to <code>ido</code>, but with emphasis on simplicity and
customizability.  Currently, there are two related packages on MELPA:
<code>swiper</code> and <code>counsel</code>:</p>

<ul>
<li><code>swiper</code> provides an <code>isearch</code> replacement, using <code>ivy-read</code> for completion, as well as the basic <code>ivy-mode</code>.</li>
<li><code>counsel</code> provides some extra commands, like <code>-M-x</code>, <code>-ag</code>, <code>-load-theme</code> etc.</li>
</ul>

<p>The reasoning behind the split into two packages is that there&#39;s less
update overhead if only one of them is updated.</p>

<h2 id="completing-read-function-conundrum"><code>completing-read-function</code> conundrum</h2>

<p>This is to explain a bit the presence of the <code>counsel</code>
package. Initially, I hoped that <code>ivy-mode</code> could do most of the work,
via the Emacs&#39; <code>completing-read-function</code> interface. How it works:
most built-in packages will call <code>completing-read</code> when they require
completion.  That function will forward the completion to
<code>completing-read-function</code> if it&#39;s set. This is the way how things
like <code>icomplete-mode</code> or <code>ivy-mode</code> or <code>helm-mode</code> work.</p>

<p>Unfortunately, the interface rather limits what you can do in
<code>completing-read-function</code>. Essentially, you&#39;re given a list of
strings and you have to return a string. You have no idea which
function called you, so you can&#39;t do any fancy stuff depending on the
caller, short of examining <code>this-command</code> which isn&#39;t very reliable.
You have no idea what will be done with the one string that you
return, so you can&#39;t do something fancy like select two or three
strings and perform that action for each of them.</p>

<p>The result is that sometimes I have to replace the built-in functions,
instead of re-using them. So instead of re-using <code>find-file</code>, I wrote
my own <code>counsel-find-file</code> that looks like this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-find-file</span> <span class="p">()</span>
  <span class="s">&quot;Forward to </span><span class="ss">`find-file&#39;</span><span class="s">.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;Find file: &quot;</span> <span class="ss">&#39;read-file-name-internal</span>
            <span class="nb">:matcher</span> <span class="nf">#&#39;</span><span class="nv">counsel--find-file-matcher</span>
            <span class="nb">:action</span>
            <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">with-ivy-window</span>
                <span class="p">(</span><span class="nv">find-file</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="nv">x</span> <span class="nv">ivy--directory</span><span class="p">))))</span>
            <span class="nb">:preselect</span> <span class="p">(</span><span class="nb">when</span> <span class="nv">counsel-find-file-at-point</span>
                         <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;ffap</span><span class="p">)</span>
                         <span class="p">(</span><span class="nv">ffap-guesser</span><span class="p">))</span>
            <span class="nb">:require-match</span> <span class="ss">&#39;confirm-after-completion</span>
            <span class="nb">:history</span> <span class="ss">&#39;file-name-history</span>
            <span class="nb">:keymap</span> <span class="nv">counsel-find-file-map</span><span class="p">))</span>
</code></pre></div>
<p>It&#39;s still possible to call the original <code>find-file</code>, and you&#39;ll get
<code>ivy-read</code> completion for it, but:</p>

<ul>
<li><code>ivy-resume</code> won&#39;t work, since <code>ivy-read</code> doesn&#39;t know what to do with the string that you select.</li>
<li><kbd>C-M-n</kbd> (<code>ivy-next-line-and-call</code>) won&#39;t work to select another file within the same completion session, for the same reason.</li>
<li><kbd>M-o</kbd> (<code>ivy-dispatching-done</code>) may work with some
customization, but since it dispatches on <code>this-command</code> to get the
extra actions, it can cause a problem if the command wasn&#39;t called
directly.</li>
</ul>

<p>I think it would be cool to extend the built-in
<code>completing-read-function</code> interface in the future Emacs
versions. Both Ivy and Helm (which uses the same strategy of passing
the action to the completion) would benefit from this.</p>

<h2 id="release-summary-and-highlights">Release summary and highlights</h2>

<p>It&#39;s been two months and 150 commits since the last version. The full
release notes can be found inside the repository in
<a href="https://github.com/abo-abo/swiper/blob/master/doc/Changelog.org">Changelog.org</a>
or at Github&#39;s
<a href="https://github.com/abo-abo/swiper/releases/tag/0.6.0">release</a> tab.</p>

<p>I recommend to look through the whole list to see if anything catches your attention.
I&#39;ll highlight a few things that I think the users might be interested in most.</p>

<h3 id="fuzzy-completion">Fuzzy completion</h3>

<p>This is off by default, since I think having less candidates is better than having more.
You can customize this for all commands or per-command. For example:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-re-builders-alist</span>
      <span class="o">&#39;</span><span class="p">((</span><span class="no">t</span> <span class="o">.</span> <span class="nv">ivy--regex-fuzzy</span><span class="p">)))</span>
</code></pre></div>
<h3 id="swiper-has-a-case-fold-search-optimization"><code>swiper</code> has a <code>case-fold-search</code> optimization</h3>

<p>Binds case-fold-search to t when the input is all lower-case:</p>

<ul>
<li>input &quot;the&quot; matches both &quot;the&quot; and &quot;The&quot;.</li>
<li>input &quot;The&quot; matches only &quot;The&quot;.</li>
</ul>

<h3 id="anzu-things">Anzu things</h3>

<p>To see not only the number of matched candidates, but also the index of the current one, set this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="k">setq</span> <span class="nv">ivy-count-format</span> <span class="s">&quot;(%d/%d) &quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="customize-additional-exit-points-for-any-command">Customize additional exit points for any command</h3>

<p>For any command that uses <code>ivy-read</code> that is. Example for <code>ivy-switch-to-buffer</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">ivy-set-actions</span>
 <span class="ss">&#39;ivy-switch-buffer</span>
 <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;k&quot;</span>
    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">kill-buffer</span> <span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">ivy--reset-state</span> <span class="nv">ivy-last</span><span class="p">))</span>
    <span class="s">&quot;kill&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;j&quot;</span>
    <span class="nv">ivy--switch-buffer-other-window-action</span>
    <span class="s">&quot;other&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>After this:</p>

<ul>
<li>Use <kbd>M-o k</kbd> to kill a buffer.</li>
<li>Use <kbd>M-o j</kbd> to switch to a buffer in other window.</li>
</ul>

<p>You can always use <kbd>M-o o</kbd> to access the default action. When there is
only one action, <kbd>M-o</kbd> does the same as <kbd>C-m</kbd>.</p>

<h3 id="more-descriptions-with-a-built-in-hydra">More descriptions with a built-in Hydra</h3>

<p>Toggle <kbd>C-o</kbd> in any completion session to get an overview of
the things that you can do.</p>

<h3 id="many-commands-that-interface-with-shell-calls">Many commands that interface with shell calls</h3>

<p>The following commands will call the appropriate shell tool to give you a list of candidates:</p>

<ul>
<li><code>counsel-git-grep</code></li>
<li><code>counsel-ag</code></li>
<li><code>counsel-locate</code></li>
<li><code>counsel-recoll</code></li>
</ul>

<p>These commands will refresh after each new letter entered, and they
account for the fact that the shell call will usually take more time
than the time it takes to input a new letter. So the process will be
killed and restarted, resulting in virtually no keyboard delay and no
downtime.</p>

<h3 id="many-commands-that-offer-more-options-than-the-built-in-counterparts">Many commands that offer more options than the built-in counterparts</h3>

<p>This list includes:</p>

<ul>
<li><code>counsel-find-file</code>,</li>
<li><code>counsel-M-x</code>,</li>
<li><code>counsel-load-theme</code>,</li>
<li><code>counsel-org-tag</code> and <code>counsel-org-tag-agenda</code>.</li>
</ul>

<p>Most extra things that you can do are:</p>

<ul>
<li>Doing stuff with multiple candidates through <kbd>C-M-n</kbd> like in <a href="https://www.youtube.com/watch?v=V_whk214fec">this video</a>.</li>
<li>Using <code>ivy-resume</code> to resume the last completion session.</li>
</ul>

<p>Make sure to try <code>counsel-org-tag</code>, this one is a bit tricky for
completion, since it requires to return multiple candidates at once.
So you can toggle each tag with <kbd>C-M-m</kbd> (<code>ivy-call</code>) and then
exit with <kbd>C-m</kbd> (<code>ivy-done</code>). The currently selected tags
will be displayed in the prompt.</p>

<h2 id="outro">Outro</h2>

<p>A big thanks to all people who contributed code and issues towards
this release.  I&#39;m really happy that you&#39;re helping me to refine this
nice package.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/27/counsel-recoll/">
        Using Recoll desktop search database with Emacs
      </a>
    </h1>

    <span class="post-date">27 Jul 2015</span>

    <p>I know that most Emacs hackers love the simplicity and usability of
grep, but sometimes it just doesn&#39;t cut it.  A specific use case is my
Org-mode directory, which includes a lot of org files and PDF
files. There are just too many files for grep to be efficient, plus
the structure of PDF doesn&#39;t lend itself to grep, so another tool is
required: a desktop database.</p>

<p>I got into the topic by reading John Kitchin&#39;s post on
<a href="http://kitchingroup.cheme.cmu.edu/blog/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results/">swish-e</a>,
however, I just couldn&#39;t get that software to work. But as a reply to
his post, another tool -
<a href="https://en.wikipedia.org/wiki/Recoll">recoll</a> was mentioned on
Org-mode&#39;s mailing list. In this post, I&#39;ll give step-by-step
instructions to make Recoll work with Emacs.</p>

<h2 id="building-recoll">Building Recoll</h2>

<p>I&#39;m assuming that you&#39;re on a GNU/Linux system, since it&#39;s my
impression is that it&#39;s the easiest system for building (as in <code>make
...</code>) software. Also, it&#39;s the only system that I&#39;ve got, so it would
be hard for me to explain other systems.</p>

<p>If you want to toy around with the graphical back end of Recoll, you can install it with:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>sudo apt-get install recoll
</code></pre></div>
<p>Unfortunately, the shell tool <code>recollq</code> isn&#39;t bundled with that
package, so we need to download
<a href="http://www.lesbonscomptes.com/recoll/download.html">the sources</a>.
The current version is <a href="http://www.lesbonscomptes.com/recoll/recoll-1.20.6.tar.gz">1.20.6</a>.</p>

<h3 id="extract-the-archive">Extract the archive</h3>

<p>After downloading the archive, I open <code>~/Downloads</code> in <code>dired</code> and
press <kbd>&amp;</kbd> (<code>dired-do-async-shell-command</code>).  It guesses from
the tar.gz extension that the command should be <code>tar zxvf</code>. By
pressing <kbd>RET</kbd>, I have the archive extracted to the current
directory. I&#39;ve actually allocated <code>~/Software/</code> for installing stuff
from tarballs, since I don&#39;t want to put too much stuff in <code>~/Downloads</code>.</p>

<h3 id="open-ansi-term">Open ansi-term</h3>

<p>I navigate to the <code>recoll-1.20.6/</code> directory using <code>dired</code>, then press
<kbd>&#96;</kbd> to open an <code>*ansi-term*</code> buffer for the current
directory.</p>

<p>Here&#39;s the setup for that (part of <a href="https://github.com/abo-abo/oremacs">my full config</a>):</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">ora-terminal</span> <span class="p">()</span>
  <span class="s">&quot;Switch to terminal. Launch if nonexistent.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">get-buffer</span> <span class="s">&quot;*ansi-term*&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">switch-to-buffer</span> <span class="s">&quot;*ansi-term*&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">ansi-term</span> <span class="s">&quot;/bin/bash&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">get-buffer-process</span> <span class="s">&quot;*ansi-term*&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ora-dired-open-term</span> <span class="p">()</span>
  <span class="s">&quot;Open an </span><span class="ss">`ansi-term&#39;</span><span class="s"> that corresponds to current directory.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">current-dir</span> <span class="p">(</span><span class="nv">dired-current-directory</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">term-send-string</span>
     <span class="p">(</span><span class="nv">ora-terminal</span><span class="p">)</span>
     <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">file-remote-p</span> <span class="nv">current-dir</span><span class="p">)</span>
         <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">v</span> <span class="p">(</span><span class="nv">tramp-dissect-file-name</span> <span class="nv">current-dir</span> <span class="no">t</span><span class="p">)))</span>
           <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;ssh %s@%s\n&quot;</span>
                   <span class="p">(</span><span class="nf">aref</span> <span class="nv">v</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">aref</span> <span class="nv">v</span> <span class="mi">2</span><span class="p">)))</span>
       <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;cd &#39;%s&#39;\n&quot;</span> <span class="nv">current-dir</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">setq</span> <span class="nv">default-directory</span> <span class="nv">current-dir</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">define-key</span> <span class="nv">dired-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;`&quot;</span><span class="p">)</span> <span class="ss">&#39;ora-dired-open-term</span><span class="p">)</span>
</code></pre></div>
<h3 id="configure-and-make">Configure and make</h3>

<p>Here&#39;s a typical sequence of shell commands. </p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>./configure <span class="o">&amp;&amp;</span> make
sudo make install
<span class="nb">cd</span> query <span class="o">&amp;&amp;</span> make
which recoll
sudo cp recollq /usr/local/bin/
</code></pre></div>
<p>I was a total Linux newbie 5 years ago and had no idea about shell
commands. Using only the first two lines, you can build and install a
huge amount of software, so these are a great place to start if you
want to learn these tools. I actually got by using only those two
lines for a year a so.</p>

<p>After the first run or <code>./configure</code> it turned out that I was missing
one library, so I had to do this one and redo the <code>./configure</code> step.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>sudo apt-get install libqt5webkit5-dev
</code></pre></div>
<p>I think this one would work as well:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>sudo apt-get build-dep recoll
</code></pre></div>
<h2 id="configuring-recoll">Configuring Recoll</h2>

<p>I only launched the graphical interface to select the indexing
directory. It&#39;s the home directory by default, I didn&#39;t want that so I
chose <code>~/Dropbox/org/</code> instead. Apparently, there&#39;s a way to make the
indexing automatic via a cron job; you can even configure it via the
graphical interface: it&#39;s all good.</p>

<h2 id="using-recoll-from-emacs">Using Recoll from Emacs</h2>

<p>Emacs has great options for processing output from a shell command. So
first I had to figure out how the shell command should look like. This
should be good enough to produce a list of indexed files that contain the word &quot;Haskell&quot;:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>recollq -b <span class="s1">&#39;haskell&#39;</span>
</code></pre></div>
<p>And there&#39;s how to adapt that command to the asynchronous <code>ivy-read</code> interface:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-recoll-function</span> <span class="p">(</span><span class="nf">string</span> <span class="kp">&amp;rest</span> <span class="nv">_unused</span><span class="p">)</span>
  <span class="s">&quot;Issue recallq for STRING.&quot;</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="p">(</span><span class="nf">length</span> <span class="nf">string</span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">counsel-more-chars</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">counsel--async-command</span>
     <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;recollq -b &#39;%s&#39;&quot;</span> <span class="nf">string</span><span class="p">))</span>
    <span class="no">nil</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-recoll</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">initial-input</span><span class="p">)</span>
  <span class="s">&quot;Search for a string in the recoll database.</span>
<span class="s">You&#39;ll be given a list of files that match.</span>
<span class="s">Selecting a file will launch </span><span class="ss">`swiper&#39;</span><span class="s"> for that file.</span>
<span class="s">INITIAL-INPUT can be given as the initial minibuffer input.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;recoll: &quot;</span> <span class="ss">&#39;counsel-recoll-function</span>
            <span class="nb">:initial-input</span> <span class="nv">initial-input</span>
            <span class="nb">:dynamic-collection</span> <span class="no">t</span>
            <span class="nb">:history</span> <span class="ss">&#39;counsel-git-grep-history</span>
            <span class="nb">:action</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
                      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&quot;file://\\(.*\\)\\&#39;&quot;</span> <span class="nv">x</span><span class="p">)</span>
                        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">file-name</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="nv">x</span><span class="p">)))</span>
                          <span class="p">(</span><span class="nv">find-file</span> <span class="nv">file-name</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&quot;pdf$&quot;</span> <span class="nv">x</span><span class="p">)</span>
                            <span class="p">(</span><span class="nv">swiper</span> <span class="nv">ivy-text</span><span class="p">)))))))</span>
</code></pre></div>
<p>The code here is pretty simple:</p>

<ul>
<li>I don&#39;t start a search until at least 3 chars are entered, in order to not get too many results.</li>
<li>I mention <code>:dynamic-collection t</code> which means that <code>recollq</code> should be called after each new letter entered.</li>
<li>In <code>:action</code>, I specify to open the selected file and start a <code>swiper</code> with the current input in that file.</li>
</ul>

<h2 id="outro">Outro</h2>

<p>I hope you found this info useful. It&#39;s certainly pretty cool:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span><span class="nb">cd</span> ~/Dropbox/org <span class="o">&amp;&amp;</span> du -hs
<span class="c1"># 567M .</span>
</code></pre></div>
<p>So there&#39;s half of a gigabyte of stuff, all of it indexed, and I&#39;m
getting a file list update after each new key press in Emacs.</p>

<p>If you know of a better tool than recoll (I&#39;m not too happy that match
context that it gives via the <code>-A</code> command option), please do share.
Also, I&#39;ve just learned that there&#39;s
<a href="https://github.com/emacs-helm/helm-recoll">helm-recoll</a> out there, so
you can use that if you like Helm.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page7">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page5">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
