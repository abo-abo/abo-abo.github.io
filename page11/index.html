<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/04/16/ivy-mode/">
        Introducing ivy-mode
      </a>
    </h1>

    <span class="post-date">16 Apr 2015</span>

    <p>Today I&#39;d like to introduce a function that has completely replaced
<code>ido-mode</code> for me: <code>ivy-mode</code>. It comes with the
<a href="https://github.com/abo-abo/swiper">swiper</a> package, available both in
<a href="http://melpa.org/#/swiper">MELPA</a> and
<a href="https://elpa.gnu.org/packages/swiper.html">GNU ELPA</a>.
The latter is a bit slower to update, so the version there can be a bit outdated sometimes.</p>

<h2 id="the-quick-video-demo">The quick video demo</h2>

<p>If you prefer listening and watching to reading, check out the video
demo <a href="https://www.youtube.com/watch?v=VvnJQpTFVDc">here</a>.
It repeats most of the stuff written down below.</p>

<h2 id="generic-completion">Generic completion</h2>

<p><code>ivy-mode</code> is simply a minor mode that changes
<code>completing-read-function</code> to <code>ivy-completing-read</code> while it&#39;s active.
This function is used in most of the places where Emacs requires
completion, like:</p>

<ul>
<li><kbd>M-x</kbd> <code>execute-extended-command</code></li>
<li><kbd>C-h f</kbd> <code>describe-function</code></li>
<li><kbd>C-h v</kbd> <code>describe-variable</code></li>
<li><code>package-install</code></li>
<li><kbd>C-x b</kbd> <code>switch-to-buffer</code></li>
<li><kbd>C-x C-f</kbd> <code>find-file</code></li>
</ul>

<p>So, while <code>ivy-mode</code> is on, all these functions and more will use ivy completion.</p>

<h2 id="package-specific-completion">Package-specific completion</h2>

<h3 id="org-mode">org-mode</h3>

<p>With the most recent master version, <code>org-mode</code> will obey
<code>completing-read-function</code>, so it should work by default.  If you try
it for refiling to headings with similar names, you&#39;ll really notice
how much better <code>ivy-mode</code> is at it. <code>helm-mode</code> also does well, if
you don&#39;t mind the large window.</p>

<h3 id="magit">magit</h3>

<p>This setting is needed to use ivy completion:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">setq</span> <span class="nv">magit-completing-read-function</span> <span class="ss">&#39;ivy-completing-read</span><span class="p">)</span>
</code></pre></div>
<h3 id="find-file-in-project">find-file-in-project</h3>

<p><a href="https://github.com/technomancy/find-file-in-project">find-file-in-project</a>
will use ivy by default if it&#39;s available.</p>

<h3 id="projectile">projectile</h3>

<p>You can set this to make it work:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">setq</span> <span class="nv">projectile-completion-system</span> <span class="ss">&#39;ivy</span><span class="p">)</span>
</code></pre></div>
<h3 id="smex">smex</h3>

<p>Yes, it&#39;s also possible, since today. Although you&#39;ll have to use my
fork of <a href="https://github.com/abo-abo/smex">smex</a> if you want to try it.
I&#39;ve sent a pull request, it&#39;s all backwards-compatible, so hopefully
it&#39;ll get merged.</p>

<p>The nice thing is that <code>smex</code> can take care of the sorting all by
itself, since <code>ivy</code> doesn&#39;t do that yet.</p>

<h3 id="my-packages">my packages</h3>

<p><a href="https://github.com/abo-abo/lispy">lispy</a> and
<a href="https://github.com/abo-abo/function-args">function-args</a> use <code>ivy</code> by
default. You can also enable it for
<a href="https://github.com/abo-abo/helm-make">helm-make</a>, for which the
default is obviously <code>helm</code>.</p>

<h2 id="file-name-completion">File name completion</h2>

<p>When <code>ivy-mode</code> is on, <code>find-file</code> will also use it.  The completion
is considerably different from all other cases, since it&#39;s done in
stages, just like <code>ido-find-file</code> does it.</p>

<p>The key bindings are:</p>

<ul>
<li><kbd>RET</kbd> will select the current candidate and finish.</li>
<li><kbd>C-j</kbd> will try to continue the completion, i.e. if the
current candidate is a directory, move to that directory. But if the
current candidate is a file or <code>./</code>, then finish.</li>
<li><kbd>/</kbd> will switch to completing the sub-directories of <code>/</code>,
but if the candidate is a perfect match, it will act like
<kbd>C-j</kbd>.</li>
<li><kbd>~</kbd> will switch to completing the sub-directories of <code>~/</code>.</li>
<li><kbd>C-n</kbd> and <kbd>C-p</kbd> naturally select the next and the previous candidate.</li>
</ul>

<h2 id="what-39-s-it-all-for">What&#39;s it all for?</h2>

<p>Well, for me the advantage is obvious: I get my completion just the
way I like it.  You can use it as well if you find that you like it
more than ido.  I&#39;ll just list a list of features that I like:</p>

<ul>
<li>The current number of candidates is robustly displayed and updated after each key stroke.</li>
<li>The minibuffer is an actual editing area, where the bindings like
<kbd>C-a</kbd>, <kbd>M-DEL</kbd> and <kbd>C-k</kbd> etc. work just as
you expect. Once you internalize the way that the regex is built, you
can get your match very quickly and intuitively.</li>
<li>The actual regular expressions constructs like <code>\\b</code> or <code>$</code> and <code>^</code> work. The only thing that works differently
is the space: you can&#39;t match a single space because any amount of spaces translates into the <code>.*</code> wild card.
But you can use it to your advantage and use the space instead of all the various symbol joining constructs out there, like
<code>snake_case</code>, or <code>kebab-case</code> (yeah, it&#39;s totally called that, check the wiki), or <code>whatever/this/is/case</code>.</li>
<li>The familiar <kbd>M-&lt;</kbd> and <kbd>M-&gt;</kbd> key bindings also work as expected, navigating you to the first and last candidate respectively.
When you press <kbd>C-p</kbd> on the first match or <kbd>C-n</kbd> on the last match, the match will not change, unlike the behavior
of <code>ido</code> that has annoyed me a lot.</li>
<li>The minibuffer key bindings can actually be properly customized:
just set <code>ivy-minibuffer-map</code> to whatever you like, it won&#39;t be
changed. Even in Emacs 24.5, if you customize <code>ido-completion-map</code>,
the change will be reset.  That was fixed only in the current master.</li>
<li>You don&#39;t have to rely on <code>flx</code> or <code>flx-ido</code> to save you from the overwhelming number of matches.
Instead, you type maybe a bit more, but in return you get a <em>very consistent</em> and predictable result.
No black boxes or hidden variables that dramatically change the order of candidates from time to time.</li>
</ul>

<h2 id="outro">Outro</h2>

<p>Check it out, I hope you like it. And a big thanks to all who
contributed code or bug reports.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/04/15/hydra-idle-hint/">
        Display the initial Hydra hint with a delay
      </a>
    </h1>

    <span class="post-date">15 Apr 2015</span>

    <p>More hydra goodness incoming, this time thanks to <a href="https://github.com/joedicastro">@joedicastro</a>.
Firstly, he contributed this awesome-looking <code>twittering-mode</code> hydra to <a href="https://github.com/abo-abo/hydra/wiki/Twittering">the wiki</a>:</p>

<p><img src="https://camo.githubusercontent.com/c2c541ec30563223701609c24c5ed5ec7ebf59b6/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f43436b336a4851556b4141436e62502e706e673a6c61726765" alt="hydra-twittering.png"></p>

<p>And a similarly nice one for <a href="https://github.com/abo-abo/hydra/wiki/Helm-2">helm</a>:</p>

<p><img src="https://camo.githubusercontent.com/757f726b2010173505f1c2b32cb9292f9c20ddaa/687474703a2f2f692e696d6775722e636f6d2f696a47703675392e706e67" alt="hydra-helm-2.png"></p>

<p>You can look up the code for both hydras by following the above two links.</p>

<p>Secondly, he gave me a nice idea in <a href="https://github.com/abo-abo/hydra/issues/108">#108</a>:</p>

<blockquote>
<p>A nice thing that guide-key has is that you can set an idle time to
wait until you press a key to activate any head before show the
hydra hints buffer (explained in hydra terms). This is very helpful
when you know the key bindings by memory and you do not need to see
the hints buffer, but if you forget how to activate any head, you
simple press the hydra binding and wait the &quot;idle time&quot; and the
hints buffer is shown to help you to choose the right next binding.</p>
</blockquote>

<p>So this option is now also possible. Here&#39;s an example, using <code>hydra-toggle</code> from hydra-examples.el:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-toggle</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">blue</span>
                        <span class="nb">:idle</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="s">&quot;toggle&quot;</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="nv">abbrev-mode</span> <span class="s">&quot;abbrev&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;d&quot;</span> <span class="nv">toggle-debug-on-error</span> <span class="s">&quot;debug&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;f&quot;</span> <span class="nv">auto-fill-mode</span> <span class="s">&quot;fill&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;t&quot;</span> <span class="nv">toggle-truncate-lines</span> <span class="s">&quot;truncate&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span> <span class="s">&quot;cancel&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c C-v&quot;</span><span class="p">)</span> <span class="ss">&#39;hydra-toggle/body</span><span class="p">)</span>
</code></pre></div>
<p>So the single change from the old code is <code>:idle 1.0</code>, which means:</p>

<blockquote>
<p>After a call to <code>hydra-toggle/body</code>, instead of displaying the hint
as usual, start a timer for 1.0 seconds. Once the timer runs out,
display the hint.  But if the hydra has exited before that time,
cancel the timer.</p>
</blockquote>

<p>Typically, I&#39;m not a huge fan of timers, but it&#39;s nice to have the
option.  And indeed, I&#39;ve been noticing that I could do without a hint
for some simple and more often used hydras. But a command can go from
often to barely used quickly, and disabling the hint altogether seems
too harsh. A timer could be a nice middle ground, especially since I
can decide whether to use it or not and the interval for each specific
hydra.</p>

<p>Anyway, thanks for the contributions. Enjoy the new feature, and keep
those good ideas coming!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/04/14/hydra-org-mode/">
        Org-mode Hydras incoming!
      </a>
    </h1>

    <span class="post-date">14 Apr 2015</span>

    <h2 id="a-hydra-for-org-mode-time-clock-capture">A hydra for org-mode time/clock/capture</h2>

<p>This is a categorized version of the hydra that <a href="https://github.com/WorldsEndless">@WorldsEndless</a> contributed
today to the <a href="https://github.com/abo-abo/hydra/wiki/Hydras-by-Topic">wiki</a>.</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-global-org</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">blue</span>
                            <span class="nb">:hint</span> <span class="no">nil</span><span class="p">)</span>
  <span class="s">&quot;</span>
<span class="s">Timer^^        ^Clock^         ^Capture^</span>
<span class="s">--------------------------------------------------</span>
<span class="s">s_t_art        _w_ clock in    _c_apture</span>
<span class="s"> _s_top        _o_ clock out   _l_ast capture</span>
<span class="s">_r_eset        _j_ clock goto</span>
<span class="s">_p_rint</span>
<span class="s">&quot;</span>
  <span class="p">(</span><span class="s">&quot;t&quot;</span> <span class="nv">org-timer-start</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;s&quot;</span> <span class="nv">org-timer-stop</span><span class="p">)</span>
  <span class="c1">;; Need to be at timer</span>
  <span class="p">(</span><span class="s">&quot;r&quot;</span> <span class="nv">org-timer-set-timer</span><span class="p">)</span>
  <span class="c1">;; Print timer value to buffer</span>
  <span class="p">(</span><span class="s">&quot;p&quot;</span> <span class="nv">org-timer</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;w&quot;</span> <span class="p">(</span><span class="nv">org-clock-in</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
  <span class="p">(</span><span class="s">&quot;o&quot;</span> <span class="nv">org-clock-out</span><span class="p">)</span>
  <span class="c1">;; Visit the clocked task from any buffer</span>
  <span class="p">(</span><span class="s">&quot;j&quot;</span> <span class="nv">org-clock-goto</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;c&quot;</span> <span class="nv">org-capture</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;l&quot;</span> <span class="nv">org-capture-goto-last-stored</span><span class="p">))</span>
</code></pre></div>
<p>I&#39;ve bound it like this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">global-set-key</span> <span class="nv">[f11]</span> <span class="ss">&#39;hydra-global-org/body</span><span class="p">)</span>
</code></pre></div>
<p>Previously, I had <kbd>f11</kbd> bound to <code>org-clock-goto</code>, thanks to
the <a href="http://doc.norang.ca/org-mode.html">Org Mode - Organize Your Life In Plain Text!</a>
post.  I kind of recommend that post, as it has a tonne of useful
stuff. At the same time, it resulted in me copying too much stuff that I didn&#39;t understand into my config,
ultimately discouraging me from using <code>org-mode</code>. YMMV.</p>

<p>Screenshot:</p>

<p><img src="/download/hydra-org-global.png" alt="hydra-org-global.png"></p>

<h2 id="a-hydra-for-refile-archive">A hydra for refile/archive</h2>

<p>Inspired by the previous one, I wanted to write a hydra of my own.  As
it happened, I was just about to clean up my git notes. So I wanted a
nice refile hydra to speed up the process.</p>

<p>Here&#39;s the hydra&#39;s code, which is now part of
<a href="https://github.com/abo-abo/worf">worf</a>.  Worf is a package for
quickly navigating around an <code>org-mode</code> buffer, you can get it from
MELPA.</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-refile</span> <span class="p">(</span><span class="nb">:hint</span> <span class="no">nil</span>
                        <span class="nb">:color</span> <span class="nv">teal</span><span class="p">)</span>
  <span class="s">&quot;</span>
<span class="s">Refile:^^   _k_eep: %`org-refile-keep</span>
<span class="s">----------------------------------</span>
<span class="s">_l_ast      _a_rchive</span>
<span class="s">_o_ther</span>
<span class="s">_t_his</span>

<span class="s">&quot;</span>
  <span class="p">(</span><span class="s">&quot;t&quot;</span> <span class="nv">worf-refile-this</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;o&quot;</span> <span class="nv">worf-refile-other</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;l&quot;</span> <span class="nv">worf-refile-last</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;k&quot;</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">org-refile-keep</span> <span class="p">(</span><span class="nv">not</span> <span class="nv">org-refile-keep</span><span class="p">))</span>
       <span class="nb">:exit</span> <span class="no">nil</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="nv">org-archive-subtree</span><span class="p">))</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span> <span class="s">&quot;quit&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Some explanations:</p>

<ul>
<li><code>worf-refile-this</code> will give you a choice of this file&#39;s headings for refiling.</li>
<li><code>worf-refile-other</code> will give you a choice of your <code>org-refile-targets</code> except the current file.</li>
<li><code>worf-refile-last</code> will refile to the last refile location without prompting.</li>
<li><kbd>k</kbd> will toggle <code>org-refile-keep</code>, which decides if refiling moves or copies the text.</li>
</ul>

<p>And here&#39;s how it looks like:</p>

<p><img src="/download/hydra-refile.png" alt="hydra-refile.png"></p>

<h2 id="outro">Outro</h2>

<p>Thanks for the contribution, enjoy the new stuff.
Also, if you ever want to dig around someone&#39;s git notes, you can read <a href="/public/git-notes/git.html">mine</a>,
courtesy of <code>org-mode</code> export.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/04/13/hydra-0.13.0/">
        Hydra 0.13.0 is out
      </a>
    </h1>

    <span class="post-date">13 Apr 2015</span>

    <p>A lot of the changes for this release aren&#39;t very user-visible, although they
are important in improving the usability.  The main change is the move from the
standard <code>set-transient-map</code> to my own <code>hydra-set-transient-map</code>.</p>

<p>This change has allowed to remove the part where the amaranth and pink hydras
intercept a binding which doesn&#39;t belong to them and then try to forward it back
to Emacs. It was done in this way, which might be interesting for people who
write Elisp:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">hydra-keymap</span> <span class="no">t</span> <span class="ss">&#39;hydra-intercept</span><span class="p">)</span>
</code></pre></div>
<p>Binding <code>t</code> means that when the keymap is active, any binding which doesn&#39;t
belong to the keymap will be interpreted as <code>t</code>.  Then, I would use <code>lookup-key</code>
and <code>this-command-keys</code> and try to call the result.  That method was quite
fragile:</p>

<ul>
<li>It didn&#39;t work for prefix keys while a pink hydra was active.</li>
<li>It didn&#39;t work for some keys in the terminal because of <code>input-decode-map</code>.</li>
</ul>

<p>The new method solves the mentioned issues by not using <code>t</code> and instead running
this function in the <code>pre-command-hook</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">hydra--clearfun</span> <span class="p">()</span>
  <span class="s">&quot;Disable the current Hydra unless `this-command&#39; is a head.&quot;</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">memq</span> <span class="nv">this-command</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">handle-switch-frame</span>
                           <span class="nv">keyboard-quit</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">hydra-disable</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">this-command</span>
                <span class="p">(</span><span class="nf">lookup-key</span> <span class="nv">hydra-curr-map</span>
                            <span class="p">(</span><span class="nf">this-single-command-keys</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">cl-case</span> <span class="nv">hydra-curr-foreign-keys</span>
                <span class="p">(</span><span class="ne">warn</span>
                 <span class="p">(</span><span class="k">setq</span> <span class="nv">this-command</span> <span class="ss">&#39;hydra-amaranth-warn</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">run</span>
                 <span class="no">t</span><span class="p">)</span>
                <span class="p">(</span><span class="no">t</span> <span class="no">nil</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">hydra-disable</span><span class="p">)))))</span>
</code></pre></div>
<p>This approach is actually very similar to what the built-in <code>set-transient-map</code>
does from Emacs 24.4 onward.  Of course, changing the a large cog in the Hydra
mechanism can lead to some new bugs, or even old bugs to re-surface. So I really
appreciate the help from <a href="https://github.com/jhonnyseven">@jhonnyseven</a> in testing the new code.</p>

<p>As always, if you find something very broken, you can roll back to <a href="http://elpa.gnu.org/packages/hydra.html">the GNU ELPA version</a>
and raise an <a href="https://github.com/abo-abo/hydra/issues">issue</a>.</p>

<h2 id="fixes">Fixes</h2>

<h3 id="single-command-red-blue-issue">single command red/blue issue</h3>

<p>Fix the uniqueness issue, when a single command is assigned to both a
red and a blue head.</p>

<p>Here&#39;s an example:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-zoom</span> <span class="p">(</span><span class="nv">global-map</span> <span class="s">&quot;&lt;f2&gt;&quot;</span><span class="p">)</span>
  <span class="s">&quot;zoom&quot;</span>
  <span class="p">(</span><span class="s">&quot;g&quot;</span> <span class="nv">text-scale-increase</span> <span class="s">&quot;in&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;l&quot;</span> <span class="nv">text-scale-decrease</span> <span class="s">&quot;out&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="nv">text-scale-set</span> <span class="mi">0</span><span class="p">)</span> <span class="s">&quot;reset&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="nv">text-scale-set</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">:bind</span> <span class="no">nil</span> <span class="nb">:exit</span> <span class="no">t</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="nv">text-scale-set</span> <span class="mi">0</span><span class="p">)</span> <span class="no">nil</span> <span class="nb">:bind</span> <span class="no">nil</span> <span class="nb">:exit</span> <span class="no">t</span><span class="p">))</span>
</code></pre></div>
<p>Here, three heads are assigned <code>(text-scale-set 0)</code>, however their behavior is different:</p>

<ul>
<li><kbd>r</kbd> doesn&#39;t exit and has a string hint.</li>
<li><kbd>0</kbd> exits and has an empty hint (so only the key is in the docstring).</li>
<li><kbd>1</kbd> exits and has a nil hint (will not be displayed in the docstring).</li>
</ul>

<p>The latter two call <code>hydra-zoom/lambda-0-and-exit</code>, while <kbd>r</kbd>
calls <code>hydra-zoom/lambda-r</code>.</p>

<h3 id="don-39-t-default-hydra-repeast-prefix-arg-to-1">Don&#39;t default <code>hydra-repeast--prefix-arg</code> to 1</h3>

<p>See <a href="https://github.com/abo-abo/hydra/issues/61">#61</a> for more info.</p>

<h3 id="allow-hydra-repeat-to-take-a-numeric-arg">Allow <code>hydra-repeat</code> to take a numeric arg</h3>

<p>For <code>hydra-vi</code>, it&#39;s now possible to do this <kbd>4j.2..</kbd>.
The line will be forwarded:</p>

<ul>
<li>4 times by <kbd>4j</kbd></li>
<li>4 times by <kbd>.</kbd></li>
<li>2 times by <kbd>2.</kbd></li>
<li>2 times by <kbd>.</kbd></li>
</ul>

<p>See <a href="https://github.com/abo-abo/hydra/issues/92">#92</a> for more info.</p>

<h3 id="key-chord-will-be-disabled-for-the-duration-of-a-hydra">Key chord will be disabled for the duration of a hydra</h3>

<p>This means that hydras have become much more easy to use with key chords.  For
instance, if <kbd>dj</kbd> key chord calls a hydra or is part of the hydra, you
won&#39;t call the <kbd>jj</kbd> key chord by accident with <kbd>djj</kbd>.</p>

<p>See <a href="https://github.com/abo-abo/hydra/issues/97">#97</a> for more info.</p>

<h2 id="new-features">New Features</h2>

<h3 id="variable-as-a-string-docstring-spec">Variable as a string docstring spec</h3>

<p>You can now use this form in your hydras:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">defvar</span> <span class="nv">foo</span> <span class="s">&quot;a b c&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defhydra</span> <span class="nv">bar</span> <span class="p">()</span>
  <span class="s">&quot;</span>
<span class="s">  bar %s`foo</span>
<span class="s">&quot;</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="ss">&#39;t</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span><span class="p">))</span>
</code></pre></div>
<p>Previously, it would only work for <code>%s(foo)</code> forms.</p>

<h3 id="bind-property-can-also-be-a-keymap"><code>:bind</code> property can also be a keymap</h3>

<p>If you remember, you can set <code>:bind</code> in the body to define in which way the
heads should be bound <em>outside</em> the Hydra. You also assign/override <code>:bind</code> for
each head.  This is especially useful to set <code>:bind</code> to nil for a few heads that
you don&#39;t want to bind outside.</p>

<p>Previously, <code>:bind</code> could be either a lambda or nil. Now a keymap is also accepted.</p>

<h3 id="integration-tests">Integration tests</h3>

<p>In addition to the abundant macro-expansion tests, integration tests are now
also running, both for <code>emacs24</code> and for <code>emacs-snapshot</code>. This means that hydra
should be a lot more stable now.</p>

<p>Here&#39;s an example test:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-simple-1</span> <span class="p">(</span><span class="nv">global-map</span> <span class="s">&quot;C-c&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="nf">insert</span> <span class="s">&quot;j&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="s">&quot;b&quot;</span> <span class="p">(</span><span class="nf">insert</span> <span class="s">&quot;k&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span><span class="p">))</span>

<span class="p">(</span><span class="nb">ert-deftest</span> <span class="nv">hydra-integration-1</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">should</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nv">hydra-with</span> <span class="s">&quot;|&quot;</span>
                               <span class="p">(</span><span class="nf">execute-kbd-macro</span>
                                <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c aabbaaqaabbaa&quot;</span><span class="p">)))</span>
                   <span class="s">&quot;jjkkjjaabbaa|&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">should</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nv">hydra-with</span> <span class="s">&quot;|&quot;</span>
                               <span class="p">(</span><span class="k">condition-case</span> <span class="no">nil</span>
                                   <span class="p">(</span><span class="nf">execute-kbd-macro</span>
                                    <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c aabb C-g&quot;</span><span class="p">))</span>
                                 <span class="p">(</span><span class="nv">quit</span> <span class="no">nil</span><span class="p">))</span>
                               <span class="p">(</span><span class="nf">execute-kbd-macro</span> <span class="s">&quot;aaqaabbaa&quot;</span><span class="p">))</span>
                   <span class="s">&quot;jjkkaaqaabbaa|&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>In the tests above, <code>hydra-simple</code> is a defined and bound hydra. <code>&quot;|&quot;</code>
represents the buffer text (empty), where <code>|</code> is the point position.
And <code>(kbd &quot;C-c aabbaaqaabbaa&quot;)</code> represents the key sequence that you can normally press by hand.
Finally, <code>&quot;jjkkjjaabbaa|&quot;</code> is what the buffer and the point position should look like afterwards.
If you find a hydra bug, it would be really cool to submit a new integration test to make sure that
this bug doesn&#39;t happen in the future.</p>

<h3 id="basic-error-handling">Basic error handling</h3>

<p>I really like the <a href="https://github.com/jwiegley/use-package">use-package</a> feature where it catches load-time errors and issues a message instead of bringing up the debugger. This is really useful, since it&#39;s hard to fix the bug with a mostly broken Emacs, in the case when the error happened early in the load process. So the same behavior now happens with <code>defhydra</code>. In case of an error, <code>defhydra</code> will be equivalent to a no-op, and the error message will be written to the <code>*Messages*</code> buffer.</p>

<h3 id="use-a-variable-instead-of-a-function-for-the-hint">Use a variable instead of a function for the hint</h3>

<p>This leads up to the yet unresolved <a href="https://github.com/abo-abo/hydra/issues/86">#86</a>, which asks
for heads to be activated conditionally.</p>

<p>For now, you can modify the docstring on your own if you wish.
Here&#39;s some code from the expansion of <code>hydra-zoom</code> to explain what I mean:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nf">set</span>
 <span class="p">(</span><span class="k">defvar</span> <span class="nv">hydra-zoom/hint</span> <span class="no">nil</span>
   <span class="s">&quot;Dynamic hint for hydra-zoom.&quot;</span><span class="p">)</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="nf">format</span>
   <span class="o">#(</span><span class="s">&quot;zoom: [g]: in, [l]: out.&quot;</span>
     <span class="mi">7</span> <span class="mi">8</span> <span class="p">(</span><span class="nv">face</span> <span class="nv">hydra-face-red</span><span class="p">)</span>
     <span class="mi">16</span> <span class="mi">17</span> <span class="p">(</span><span class="nv">face</span> <span class="nv">hydra-face-red</span><span class="p">))))</span>
<span class="c1">;; in head body:</span>
<span class="p">(</span><span class="nb">when</span> <span class="nv">hydra-is-helpful</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">hydra-lv</span>
      <span class="p">(</span><span class="nv">lv-message</span>
       <span class="p">(</span><span class="nf">eval</span> <span class="nv">hydra-zoom/hint</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">message</span>
     <span class="p">(</span><span class="nf">eval</span> <span class="nv">hydra-zoom/hint</span><span class="p">))))</span>
</code></pre></div>
<p>Eventually, I&#39;ll add some automatic stuff to fix #86. But for now, you can
experiment with modifying e.g. <code>hydra-zoom/hint</code> inside heads, if you want.</p>

<h3 id="multiple-inheritance-for-hydra-heads">Multiple inheritance for Hydra heads</h3>

<p>Each hydra, e.g. <code>hydra-foo</code> will now declare its own heads as a variable
<code>hydra-foo/heads</code>. It&#39;s possible to inherit them like this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-zoom</span> <span class="p">(</span><span class="nv">global-map</span> <span class="s">&quot;&lt;f2&gt;&quot;</span><span class="p">)</span>
  <span class="s">&quot;zoom&quot;</span>
  <span class="p">(</span><span class="s">&quot;g&quot;</span> <span class="nv">text-scale-increase</span> <span class="s">&quot;in&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;s&quot;</span> <span class="nv">text-scale-decrease</span> <span class="s">&quot;out&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-arrows</span> <span class="p">()</span>
  <span class="p">(</span><span class="s">&quot;h&quot;</span> <span class="nf">backward-char</span> <span class="s">&quot;left&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;j&quot;</span> <span class="nv">next-line</span> <span class="s">&quot;down&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;k&quot;</span> <span class="nv">previous-line</span> <span class="s">&quot;up&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;l&quot;</span> <span class="nf">forward-char</span> <span class="s">&quot;right&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-zoom-child</span> <span class="p">(</span><span class="nb">:inherit</span> <span class="p">(</span><span class="nv">hydra-zoom/heads</span>
                                      <span class="nv">hydra-arrows/heads</span><span class="p">)</span>
                            <span class="nb">:color</span> <span class="nv">amaranth</span><span class="p">)</span>
  <span class="s">&quot;zoom&quot;</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span><span class="p">))</span>
</code></pre></div>
<p>Here, <code>hydra-zoom-child</code> inherits the heads of <code>hydra-zoom</code> and <code>hydra-arrows</code>.
It adds one more head <kbd>q</kbd> to quit. Also, it changes the color to
amaranth, which means that it&#39;s only possible to exit it with <kbd>q</kbd> or
<kbd>C-g</kbd>. This hydra&#39;s parents remain at their original (red) color.</p>

<p>See <a href="https://github.com/abo-abo/hydra/issues/57">#57</a> for more info.</p>

<h2 id="outro">Outro</h2>

<p>A big thanks to all who contributed towards this release and to <a href="https://github.com/abo-abo/hydra/wiki">the wiki</a>.
If you have an idea that would be cool in Hydra, do raise <a href="https://github.com/abo-abo/hydra/issues">an issue</a>.
And if you written some cool code that uses the already available Hydra features, please share it on the wiki.
It&#39;s also a good way to protect your code against regressions (although the best one would be an integration test).</p>

<p>Finally, check out the new version of
<a href="https://github.com/joostkremers/pandoc-mode">pandoc-mode</a> which is
one of the coolest and most elaborate uses of Hydra yet.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/04/09/counsel-completion/">
        Complete stuff with Counsel
      </a>
    </h1>

    <span class="post-date">09 Apr 2015</span>

    <h2 id="intro">Intro</h2>

<p>If you like my package <a href="https://github.com/abo-abo/swiper">swiper</a>,
I&#39;m sure you&#39;ll also like <a href="http://melpa.org/#/counsel">counsel</a>. It
lives in the same repository, but you can install it separately from
MELPA.</p>

<p>Counsel uses <code>ivy</code> - the same method as <code>swiper</code> to:</p>

<ul>
<li>Complete Elisp at point with <code>counsel-el</code>.</li>
<li>Complete Clojure at point with <code>counsel-clj</code>.</li>
<li>Open a git-managed file with <code>counsel-git</code>.</li>
<li>Describe an Elisp variable with <code>counsel-describe-variable</code>.</li>
<li>Describe an Elisp function with <code>counsel-describe-function</code>.</li>
<li>Look up an Elisp symbol in the info with <code>counsel-info-lookup-symbol</code>.</li>
<li>Insert a Unicode character at point with <code>counsel-unicode-char</code>.</li>
</ul>

<p>Below, I&#39;ll describe the functions that I added just today.</p>

<h3 id="counsel-describe-function"><code>counsel-describe-function</code></h3>

<p>This is just a replacement for <code>describe-function</code>:</p>

<p><img src="/download/counsel-describe-function.png" alt="counsel-describe-function.png"></p>

<p>As you can see, regular expressions work here as well.  The
space-splitting behavior is the same as in <code>swiper</code>, so don&#39;t expect
to be able to match a single space: spaces are wild.</p>

<h3 id="counsel-describe-variable"><code>counsel-describe-variable</code></h3>

<p>This is just a replacement for <code>describe-variable</code>:</p>

<p><img src="/download/counsel-describe-variable.png" alt="counsel-describe-variable.png"></p>

<p>Well, actually I&#39;ve used <code>ido-mode</code> with <code>flx</code> matching for these two
functions before. In my experience, <code>ivy</code> handles much better:</p>

<ul>
<li>you are in charge of which regex you&#39;re searching for</li>
<li>you see the candidate count</li>
<li>no crazy wrap-around candidate cycling</li>
</ul>

<p>And it works faster, too.</p>

<p>Here are my bindings:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;&lt;f1&gt; f&quot;</span><span class="p">)</span> <span class="ss">&#39;counsel-describe-function</span><span class="p">)</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;&lt;f1&gt; v&quot;</span><span class="p">)</span> <span class="ss">&#39;counsel-describe-variable</span><span class="p">)</span>
</code></pre></div>
<h3 id="counsel-info-lookup-symbol"><code>counsel-info-lookup-symbol</code></h3>

<p><img src="/download/counsel-info-lookup-symbol.png" alt="counsel-info-lookup-symbol.png"></p>

<p>I don&#39;t use this one too often, but it&#39;s nice to have the option:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;&lt;f2&gt; i&quot;</span><span class="p">)</span> <span class="ss">&#39;counsel-info-lookup-symbol</span><span class="p">)</span>
</code></pre></div>
<h3 id="counsel-unicode-char"><code>counsel-unicode-char</code></h3>

<p><img src="/download/counsel-unicode-char.png" alt="counsel-unicode-char.png"></p>

<p>At around 40000 candidates, <code>ivy</code> starts to feel clunky (around 0.1s
display delay). Unfortunately, I don&#39;t really see a way around this,
except using tricks like <code>while-no-input</code>, which didn&#39;t work right
when I tried it earlier. It would be really cool to do the completion
in another thread, but alas.</p>

<h2 id="outro">Outro</h2>

<p>Give the new functions a try. I think <code>ivy</code> can become a viable <code>ido</code>
replacement, at least it has done so for me: the only <code>ido</code> functions
that I&#39;m still using are <code>ido-switch-buffer</code> and <code>ido-find-file</code>.</p>

<p>Also, if you&#39;re using <code>projectile</code>, you can use <code>ivy</code> completion for it:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">setq</span> <span class="nv">projectile-completion-system</span> <span class="ss">&#39;ivy</span><span class="p">)</span>
</code></pre></div>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page12">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page10">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
