<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <link rel="canonical" href="https://oremacs.com/page2/" />

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/03/28/emacs-cpp-ide/">
        Using Emacs as a C++ IDE
      </a>
    </h1>

    <span class="post-date">28 Mar 2017</span>

    <p>Recently, I&#39;ve had to code some C++ at work. And I saw it as a good
opportunity to step up my Emacs&#39; IDE game. I&#39;ve eschewed clang-based
tools until now, but GCC isn&#39;t adding AST support any time soon, and
CEDET is too slow and too clumsy with macros for the particular
project that I
had. Here&#39;s
<a href="https://bitbucket.org/eigen/eigen/src/525f03452c37a400bcc4df194950fa97aa61936a/Eigen/src/Core/Matrix.h?at=default&fileviewer=file-view-default#Matrix.h-426">the line</a> in
<a href="http://eigen.tuxfamily.org/index.php?title=Main_Page">Eigen</a> that
broke the camel&#39;s back. Basically it&#39;s 30 lines of macros that expand
to 30 lines of typedefs. Maybe it&#39;s a valid implementation choice, I&#39;d
rather avoid the macros altogether, but in any case I couldn&#39;t get
CEDET to parse that.</p>

<h2 id="use-rtags-for-navigation">Use Rtags for navigation</h2>

<p>The first thing I tried
was <a href="https://github.com/Andersbakken/rtags">rtags</a>.  My project was
CMake-based, so I just put this line in my subdirectory <code>Makefile</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>cmake:
    cd ../build &amp;&amp; cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 ..
</code></pre></div>
<p>The <code>-DCMAKE_EXPORT_COMPILE_COMMANDS=1</code> causes a
<code>compile_commands.json</code> file to be emitted during the actual
compilation. This file describes the compile flags for every source
file. These flags are essential in helping the parser understand
what&#39;s going on.</p>

<p>Then, in the <code>build</code> directory I start:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>rdm &amp; jc -J .
</code></pre></div>
<p>Finally, <code>rtags-find-symbol-at-point</code> should work now. I still like to
use CEDET as backup, it&#39;s pretty good at tracking variables
defined in the current function:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">ciao-goto-symbol</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">deactivate-mark</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ring-insert</span> <span class="nv">find-tag-marker-ring</span> <span class="p">(</span><span class="nf">point-marker</span><span class="p">))</span>
  <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;rtags</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
           <span class="p">(</span><span class="nv">rtags-find-symbol-at-point</span><span class="p">))</span>
      <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;semantic/ia</span><span class="p">)</span>
           <span class="p">(</span><span class="k">condition-case</span> <span class="no">nil</span>
               <span class="p">(</span><span class="nv">semantic-ia-fast-jump</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span>
             <span class="p">(</span><span class="ne">error</span> <span class="no">nil</span><span class="p">)))))</span>
<span class="p">(</span><span class="nf">define-key</span> <span class="nv">c++-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-.&quot;</span><span class="p">)</span> <span class="ss">&#39;ciao-goto-symbol</span><span class="p">)</span>
<span class="p">(</span><span class="nf">define-key</span> <span class="nv">c++-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-,&quot;</span><span class="p">)</span> <span class="ss">&#39;pop-tag-mark</span><span class="p">)</span>
</code></pre></div>
<p>For my other C++ projects which aren&#39;t CMake-based, I use the
excellent <a href="https://github.com/rizsotto/Bear">bear</a> tool to emit the
<code>compile_commands.json</code> file. It&#39;s as easy as:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>make clean
bear make
</code></pre></div>
<h2 id="use-irony-for-completion">Use Irony for completion</h2>

<p>It didn&#39;t take long to figure out that <code>rtags</code> isn&#39;t great at
completion. I almost accepted that&#39;s just the way it is.  But this
morning I decided to make some changes and
try <a href="https://github.com/Sarcasm/irony-mode">irony-mode</a>.  And it
worked beautifully for completion! What&#39;s ironic, is that <code>irony-mode</code>
doesn&#39;t have <code>goto-symbol</code>, so the time spent to figure out <code>rtags</code>
was worth it.</p>

<p>Here&#39;s my Irony setup; I only changed the <kbd>C-M-i</kbd> binding to
the newly written <code>counsel-irony</code>, now available in the <code>counsel</code>
package on MELPA:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;c++-mode-hook</span> <span class="ss">&#39;irony-mode</span><span class="p">)</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;c-mode-hook</span> <span class="ss">&#39;irony-mode</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-irony-mode-hook</span> <span class="p">()</span>
  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">irony-mode-map</span>
      <span class="p">[</span><span class="nv">remap</span> <span class="nv">completion-at-point</span><span class="p">]</span> <span class="ss">&#39;counsel-irony</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">irony-mode-map</span>
      <span class="p">[</span><span class="nv">remap</span> <span class="nv">complete-symbol</span><span class="p">]</span> <span class="ss">&#39;counsel-irony</span><span class="p">))</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;irony-mode-hook</span> <span class="ss">&#39;my-irony-mode-hook</span><span class="p">)</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;irony-mode-hook</span> <span class="ss">&#39;irony-cdb-autosetup-compile-options</span><span class="p">)</span>
</code></pre></div>
<p>And here are some screenshots of <code>counsel-irony</code>:</p>

<p><img src="/download/counsel-irony-1.png" alt="screenshot-1"></p>

<p>First of all, the completion is displayed inline, similarly to modern IDEs.
You can use all of Ivy&#39;s regex tricks to complete your candidate:</p>

<p><img src="/download/counsel-irony-2.png" alt="screenshot-2"></p>

<p>Note how the power of regex matching allows me to narrow the initial
1622 candidates to only 22 functions that have <code>src1</code> and <code>src2</code> as
arguments. One of the candidates is cut off for being longer than the
window width. You can still match against the invisible text, but you
won&#39;t see it. It&#39;s possible to use <kbd>C-c C-o</kbd> (<code>ivy-occur</code>) to
store the current candidates into a buffer:</p>

<p><img src="/download/counsel-irony-3.png" alt="screenshot-3"></p>

<p>Clicking the mouse on any of the lines in the new buffer will insert
the appropriate symbol into the C++ buffer.</p>

<h2 id="outro">Outro</h2>

<p>I&#39;d like to thank the authors of <code>rtags</code> and <code>irony-mode</code> for these
nice packages. Hopefully, <code>counsel-irony</code> is a nice addition. Happy
hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/03/18/dired-ediff/">
        Quickly ediff files from dired
      </a>
    </h1>

    <span class="post-date">18 Mar 2017</span>

    <blockquote>
<p>ediff.el --- a comprehensive visual interface to diff &amp; patch</p>
</blockquote>

<p>I wrote about
ediff <a href="https://oremacs.com/2015/01/17/setting-up-ediff/">years ago</a>.
Today, I&#39;ll just reference a useful ediff snippet
from <a href="https://github.com/abo-abo/oremacs">my config</a> that I&#39;ve added
some time ago and refined only recently.</p>

<p>The premise is quite simple: press <kbd>e</kbd> in <code>dired-mode</code> to
immediately ediff two marked files, no questions asked:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nf">define-key</span> <span class="nv">dired-mode-map</span> <span class="s">&quot;e&quot;</span> <span class="ss">&#39;ora-ediff-files</span><span class="p">)</span>
</code></pre></div>
<p>And here&#39;s the code, with a few bells and whistles:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="c1">;; -*- lexical-binding: t -*-</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">ora-ediff-files</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">wnd</span> <span class="p">(</span><span class="nf">current-window-configuration</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&lt;=</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">files</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">file1</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">files</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">file2</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">files</span><span class="p">)</span>
                         <span class="p">(</span><span class="nv">cadr</span> <span class="nv">files</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">read-file-name</span>
                        <span class="s">&quot;file: &quot;</span>
                        <span class="p">(</span><span class="nv">dired-dwim-target-directory</span><span class="p">)))))</span>
          <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">file-newer-than-file-p</span> <span class="nv">file1</span> <span class="nv">file2</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">ediff-files</span> <span class="nv">file2</span> <span class="nv">file1</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">ediff-files</span> <span class="nv">file1</span> <span class="nv">file2</span><span class="p">))</span>
          <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;ediff-after-quit-hook-internal</span>
                    <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
                      <span class="p">(</span><span class="k">setq</span> <span class="nv">ediff-after-quit-hook-internal</span> <span class="no">nil</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">set-window-configuration</span> <span class="nv">wnd</span><span class="p">))))</span>
      <span class="p">(</span><span class="ne">error</span> <span class="s">&quot;no more than 2 files should be marked&quot;</span><span class="p">))))</span>
</code></pre></div>
<p>Some notes on how the extra code adds convenience:</p>

<ol>
<li><p>In case no files are marked, the file at point is used as the first
file, and <code>read-file-name</code> is used for the second file.  Since I
have the magic <code>(setq dired-dwim-target t)</code> in my config, in case a
second <code>dired</code> buffer is open, <code>dired-dwim-target-directory</code> will
offer it as the starting directory during completion. Very useful
to compare two files in two different directories.</p></li>
<li><p>Depending on the order of the arguments to <code>ediff-files</code>, the
changes will appear either as added or removed;
<code>file-newer-than-file-p</code> tries to put the arguments in a logical
order by looking at the files&#39; last change times.</p></li>
<li><p><code>ediff-after-quit-hook-internal</code> is used to restore the previous
  window configuration after I quit <code>ediff</code> with <kbd>q</kbd>.</p></li>
</ol>

<p>That&#39;s about it. Hopefully, it&#39;s useful. Happy hacking.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/02/25/warp-9-make-it-so/">
        Make it so&#58 file1 -> Makefile -> file2
      </a>
    </h1>

    <span class="post-date">25 Feb 2017</span>

    <h2 id="intro">Intro</h2>

<p><a href="https://github.com/abo-abo/make-it-so">make-it-so</a> is an old package
of mine that I haven&#39;t yet highlighted on the blog. This package helps
you manage a collection of makefiles that are used to generate new
files from existing files using shell commands.</p>

<p>You can think of these makefiles as a directory of shell functions,
arranged by the extension of the files that they operate on:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ <span class="nb">cd</span> make-it-so <span class="o">&amp;&amp;</span> find recipes -name Makefile
recipes/ipynb/to-md/Makefile
recipes/ogv/crop/Makefile
recipes/ogv/trim/Makefile
recipes/ogv/to-gif/Makefile
recipes/pdf/to-txt/Makefile
recipes/md/to-org/Makefile
recipes/md/to-html/Makefile
recipes/cue/split/Makefile
recipes/dot/to-png/Makefile
recipes/m4a/to-mp3/Makefile
recipes/flac/to-mp3/Makefile
recipes/gif/gifsicle/Makefile
recipes/svg/to-png/Makefile
recipes/chm/to-pdf/Makefile
recipes/txt/encode-utf8/Makefile
recipes/mp4/to-mp3/Makefile
recipes/mp4/trim/Makefile
recipes/mp4/replace-audio/Makefile
recipes/png/to-gif/Makefile
</code></pre></div>
<p>When you call <code>make-it-so</code> on a particular file, you get completion
for the recipes that are available for that file extension, along with
an option to create a new recipe.</p>

<h2 id="example-1-convert-pdf-to-txt">Example 1: convert <code>pdf</code> to <code>txt</code></h2>

<p>Suppose you want to convert a PDF file <code>test.pdf</code> to a text file <code>test.txt</code>.</p>

<p>In case the recipe is in your collection, you don&#39;t have to remember
the command or the command switches to do it anymore:</p>

<ol>
<li>Navigate to <code>test.pdf</code> in <code>dired</code> and press <kbd>,</kbd> (bound to <code>make-it-so</code>).</li>
<li>Select the recipe you want using completion: <code>to-txt</code> is already provided.</li>
<li><p>Your file and the makefile recipe are moved to the staging area:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>./to-txt_test.pdf/test.pdf
./to-txt_test.pdf/Makefile
</code></pre></div></li>
<li><p>The makefile is opened in a new buffer with the following bindings:</p>

<ul>
<li><kbd>f5</kbd> (<code>mis-save-and-compile</code>) will run <code>compile</code>,
creating <code>test.txt</code> in the current directory.</li>
<li><kbd>C-,</kbd> (<code>mis-finalize</code>) will finalize the operation,
moving <code>test.pdf</code> and <code>test.txt</code> to the parent directory (where
<code>test.pdf</code> was before), and deleting the staging directory.</li>
<li><kbd>C-M-,</kbd> (<code>mis-abort</code>) will move <code>test.pdf</code> back to its
initial location and delete all generated files. This command is
effectively an <code>undo</code> for <code>make-it-so</code>.</li>
</ul></li>
</ol>

<p>It takes a large chunk of text to describe everything, but the key sequence for doing all this is quite short:</p>

<ol>
<li><kbd>,</kbd> - <code>make-it-so</code>.</li>
<li><kbd>RET</kbd> - select <code>to-txt</code>.</li>
<li><kbd>f5</kbd> - create <code>test.txt</code>.</li>
<li><kbd>C-,</kbd> - finalize.</li>
</ol>

<h2 id="example-2-make-a-gif-from-a-series-of-png-images">Example 2: make a gif from a series of png images</h2>

<p>I&#39;ll describe the process of creating a high quality gif like this
one, which describes the effect of the <kbd>C</kbd> key
in <a href="https://github.com/abo-abo/lispy">lispy</a>:</p>

<p><img src="/download/lispy-convolute.gif" alt="lispy-convolute"></p>

<p>First, I use <a href="https://launchpad.net/kazam">kazam</a> to take two <code>png</code>
screenshots of my Emacs screen:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ ls -1 *.png
Screenshot <span class="m">2017</span>-02-25 <span class="m">16</span>:14:49.png
Screenshot <span class="m">2017</span>-02-25 <span class="m">16</span>:15:10.png
</code></pre></div>
<p>I plan to use <a href="https://www.lcdf.org/gifsicle/">gifsicle</a> to sequence
the still images into a gif. But it only takes <code>gif</code> as the input
format, so first I have to convert my <code>png</code> files to non-animated
<code>gif</code> files.</p>

<p>I open the <code>dired</code> buffer where they are located and mark them with
<kbd>m</kbd> (<code>dired-mark</code>). Then call <code>make-it-so</code> with <kbd>,</kbd>
and select <code>to-gif</code> recipe.  This recipe has no parameters, so there&#39;s
nothing else to do but <kbd>f5 C-,</kbd>. Two new files are created:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ ls -1 *.png *.gif
Screenshot_2017-02-25 <span class="m">16</span>:14:49.gif
Screenshot_2017-02-25 <span class="m">16</span>:14:49.png
Screenshot_2017-02-25 <span class="m">16</span>:15:10.gif
Screenshot_2017-02-25 <span class="m">16</span>:15:10.png
</code></pre></div>
<p>Note that the file names (the defaults of <code>kazam</code>) are problematic
when used with makefiles, since they contain spaces and colons. The
Elisp layer of <code>make-it-so</code> takes care of that. It renames the files
back and forth so that the logic in the makefiles remains simple.</p>

<p>Next, I mark the two <code>gif</code> files using <kbd>*%</kbd>
(<code>dired-mark-files-regexp</code>), press <kbd>,</kbd> once more and select
the <code>gifsicle</code> recipe. I&#39;m presented a makefile with the following
contents:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span><span class="c"># ——— parameters —————————————————————————————————</span>

<span class="c"># delay between frames in hundredths of a second</span>
<span class="nv">delay</span> <span class="o">=</span> <span class="m">60</span>

<span class="c"># ——— implementation —————————————————————————————</span>
<span class="nv">DIRGIF</span> <span class="o">=</span> <span class="k">$(</span>shell ls *.gif <span class="p">|</span> grep -v anime.gif<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">anime</span>.<span class="n">gif</span>

<span class="nf">anime.gif</span><span class="o">:</span> <span class="n">Makefile</span> <span class="k">$(</span><span class="nv">DIRGIF</span><span class="k">)</span>
    rm -f anime.gif
    gifsicle --delay<span class="o">=</span><span class="k">$(</span>delay<span class="k">)</span> --colors<span class="o">=</span><span class="m">256</span> --loop <span class="k">$(</span>DIRGIF<span class="k">)</span> &gt; <span class="nv">$@</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&gt; provide

<span class="nf">clean</span><span class="o">:</span>
    rm -f anime.gif provide

<span class="nf">install-tools</span><span class="o">:</span>
    sudo apt-get install gifsicle

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">install</span>-<span class="n">tools</span> <span class="n">clean</span>
</code></pre></div>
<p>The most commonly useful parameter, the delay between frames, is
nicely documented at the top. I don&#39;t have to remember that the switch
name is <code>--delay</code> or that the switch style <code>--delay=60</code> is used. I
simply change the number above until I get the result that I want.</p>

<h2 id="example-3-add-a-new-recipe">Example 3: add a new recipe</h2>

<p>As a sample scenario, assume you want to convert *.svg to *.png.</p>

<h3 id="step-1">Step 1</h3>

<p>An internet search leads to <a href="http://stackoverflow.com/questions/9853325/how-to-convert-a-svg-to-a-png-with-image-magick">Stack Overflow</a> and this command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>inkscape -z -e test.png -w 1024 -h 1024 test.svg
</code></pre></div>
<p>Navigate to the file(s) in <code>dired</code> and call <code>make-it-so</code> with
<kbd>,</kbd>.  No default actions are available, so just type &quot;to-png&quot;
and hit <kbd>RET</kbd>.  The &quot;to-&quot; prefix signifies that this is a
conversion, adapting the Makefile to this form:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span><span class="c"># This is a template for the Makefile.</span>
<span class="c"># Parameters should go in the upper half as:</span>
<span class="c">#     width = 200</span>
<span class="c"># and be referenced in the command as $(width)</span>

<span class="c"># ____________________________________________</span>

<span class="nv">DIRSVG</span> <span class="o">=</span> <span class="k">$(</span>shell dir *.svg<span class="k">)</span>

<span class="nv">DIRPNG</span> <span class="o">=</span> <span class="k">$(</span>DIRSVG:.svg<span class="o">=</span>.png<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">clean</span> <span class="n">Makefile</span> <span class="k">$(</span><span class="nv">DIRPNG</span><span class="k">)</span>

<span class="nf">%.png</span><span class="o">:</span> %.<span class="n">svg</span>
    <span class="nb">echo</span> <span class="s2">&quot;add command here&quot;</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&gt; provide

<span class="nf">clean</span><span class="o">:</span>
    rm -f *.png provide

<span class="c"># Insert the install command here.</span>
<span class="c"># e.g. sudo apt-get install ffmpeg</span>
<span class="nf">install-tools</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="s2">&quot;No tools required&quot;</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">install</span>-<span class="n">tools</span> <span class="n">clean</span>
</code></pre></div>
<p>If the action name doesn&#39;t have a &quot;to-&quot; prefix, the transformation is
assumed to be e.g. &quot;svg&quot; -&gt; &quot;out.svg&quot;. You can change this of course
by editing the Makefile.</p>

<h3 id="step-2">Step 2</h3>

<p>In case the command needs additional packages in order to work you
might want to change <code>echo &quot;No tools required&quot;</code> to the appropriate
package install instruction, e.g. <code>sudo apt-get install inkscape</code>.</p>

<p>When you&#39;re on a new system, this will serve as a reminder of what you
should install in order for the Makefile to work. Simply call:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>make install-tools
</code></pre></div>
<h3 id="step-3">Step 3</h3>

<p>Replace <code>echo &quot;add command here&quot;</code> with:</p>
<div class="highlight"><pre><code class="language-Makefile" data-lang="Makefile"><span></span>    inkscape -z -e <span class="nv">$@</span> -w <span class="k">$(</span>width<span class="k">)</span> -h <span class="k">$(</span>height<span class="k">)</span> $^
</code></pre></div>
<ul>
<li><p>The parameters <code>width</code> and <code>height</code> will go to the top of the
Makefile, where they can be customized.</p></li>
<li><p><code>$@</code> refers to the output file, <code>test.png</code> in this case.</p></li>
<li><p><code>$^</code> refers to the input file, <code>test.svg</code> in this case.</p></li>
</ul>

<p>That&#39;s it. You can see the final
Makefile <a href="https://raw.githubusercontent.com/abo-abo/make-it-so/master/recipes/svg/to-png/Makefile">here</a>.
Test if the command works with <kbd>f5</kbd> from the Makefile.  If
you&#39;re happy with it, call <code>mis-finalize</code> with <kbd>C-,</kbd> from
<code>dired</code>.  The Makefile will be saved for all future calls to
<code>make-it-so</code>.</p>

<h2 id="outro">Outro</h2>

<p>To summarize the advantages of <code>make-it-so</code>:</p>

<ul>
<li>Write the recipe <em>one time</em>, never have to look up how to do the
same thing a few months from now.</li>
<li>A chance to write the recipe <em>zero times</em>, if someone in the
community has already done it and shared the recipe with you.</li>
<li>The Elisp layer takes care of hairy file names.</li>
<li>Parallel commands on multiple files, i.e. <code>make -j8</code>, are provided for free.</li>
</ul>

<p>The most important usage tip: until you&#39;re sure that the command and
the Makefile work properly make backups. In fact, make backups period.
Happy hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/08/28/elf-mode/">
        elf-mode - view the symbol list in a binary
      </a>
    </h1>

    <span class="post-date">28 Aug 2016</span>

    <p>Recently, I&#39;ve been looking at
<a href="http://libigl.github.io/libigl/tutorial/tutorial.html#meshrepresentation">libigl</a>. I
didn&#39;t manage to fully figure out their CMake build system for
tutorials: although each tutorial has a <code>CMakeLists.txt</code>, it&#39;s only
possible to build them all at once.</p>

<p>So I decided to replace <code>CMakeLists.txt</code> with a good-old <code>Makefile</code>;
how hard can it be?  Concerning includes, not at all hard: the missing
files are found with <code>counsel-locate</code> and added to the include path.</p>

<p>But I had some trouble matching a missing <code>ld</code> dependency to a library
file. Fixed it with a bunch of googling and guesswork; I still wonder
if there&#39;s a better way. But in the process, I&#39;ve found this useful
command:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>readelf --syms libGL.so
</code></pre></div>
<p>which produces e.g.:</p>

<pre><small>
Symbol table '.dynsym' contains 2732 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 000000000004faf0     0 SECTION LOCAL  DEFAULT    8
     2: 00000000000e8f20     0 FUNC    GLOBAL DEFAULT   11 glGetIntegerui64i_vNV
     3: 00000000000e13e0     0 FUNC    GLOBAL DEFAULT   11 glGetMultiTexEnvfvEXT
     4: 00000000000d7440     0 FUNC    GLOBAL DEFAULT   11 glProgramUniform2uiv
     5: 00000000000cfdc0     0 FUNC    GLOBAL DEFAULT   11 glMultiTexCoord3sv
</small></pre>

<p>This is a pretty good representation of a binary file: in this
example, instead of one megabyte of gibberish I see a bit more than
2732 lines describing the functions this file uses and provides.</p>

<h2 id="viewing-the-symbol-list-automatically">Viewing the symbol list automatically</h2>

<p>I liked the above representation so much that I want to see it by
default. In Emacs, it&#39;s pretty easy to do with <code>auto-mode-alist</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;auto-mode-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;\\.\\(?:a\\|so\\)\\&#39;&quot;</span> <span class="o">.</span> <span class="nv">elf-mode</span><span class="p">))</span>
</code></pre></div>
<p>The above code instructs Emacs to call <code>elf-mode</code> function whenever
the file name ends in <code>*.a</code> or <code>*.so</code>.</p>

<p>And here&#39;s the body of <code>elf-mode</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nb">defvar-local</span> <span class="nv">elf-mode</span> <span class="no">nil</span><span class="p">)</span>

<span class="c1">;;;###autoload</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">elf-mode</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">inhibit-read-only</span> <span class="no">t</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">elf-mode</span>
        <span class="p">(</span><span class="k">progn</span>
          <span class="p">(</span><span class="nf">delete-region</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">)</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
          <span class="p">(</span><span class="nf">insert-file-contents</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">))</span>
          <span class="p">(</span><span class="k">setq</span> <span class="nv">elf-mode</span> <span class="no">nil</span><span class="p">))</span>
      <span class="p">(</span><span class="k">setq</span> <span class="nv">elf-mode</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">delete-region</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">)</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nv">shell-command-to-string</span>
               <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;readelf --syms %s&quot;</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">set-buffer-modified-p</span> <span class="no">nil</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">1</span><span class="p">)))</span>
</code></pre></div>
<p>The idea is very simple: <code>elf-mode</code> is a toggle function that replaces
the buffer contents with the shell command output. It carefully uses
<code>read-only-mode</code> and <code>set-buffer-modified-p</code> so that the file will not
be overwritten by accident with the symbol names.</p>

<h2 id="using-autoload-to-avoid-overhead">Using autoload to avoid overhead</h2>

<p>As you might imagine, looking at binaries isn&#39;t really a common
task. Is it worth to be dragging this code around from now on, loading
it on each start? The answer is yes, of course. Since the actual cost
is negligible until the feature is used.</p>

<p>If you look above, <code>elf-mode</code> has an <code>;;;###autoload</code> cookie before
it. The cookie results in this line in my <code>loaddefs.el</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nf">autoload</span> <span class="ss">&#39;elf-mode</span> <span class="s">&quot;modes/ora-elf&quot;</span> <span class="s">&quot;&quot;</span> <span class="no">t</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div>
<p>My <code>init.el</code> always loads <code>loaddefs.el</code>, but never loads <code>ora-elf.el</code>
where the function is defined. That file is only loaded when the
function <code>elf-mode</code> is called for the first time. The above <code>autoload</code>
statement simply instructs Emacs to load a particular file when
<code>elf-mode</code> needs to be called.</p>

<p>When you use the package manager, the autoloads file is generated and
loaded for you automatically:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>$ tree elpa/ace-link-20160811.112/

elpa/ace-link-20160811.112/
├── ace-link-autoloads.el
├── ace-link.el
├── ace-link.elc
└── ace-link-pkg.el

<span class="m">0</span> directories, <span class="m">4</span> files
</code></pre></div>
<p>Here, the package manager will always load <code>ace-link-autoloads.el</code>,
which instructs Emacs to load <code>ace-link.el</code> when one of the
<code>;;;###autoload</code> functions is called and <code>ace-link.el</code> isn&#39;t yet
loaded.</p>

<p>As an example of how useful delayed loading is: my 6000 line
<a href="https://github.com/abo-abo/oremacs">config</a> starts in 1.8 seconds.
About 40% of that time is spent on <code>(package-initialize)</code>, which I
assume is the package manager loading all those <code>*-autoloads.el</code> files
that I have in my <code>elpa/</code>.</p>

<h2 id="outro">Outro</h2>

<p>Let me know if there&#39;s interest to have <code>elf-mode</code> on MELPA.  Also, if
anyone knows how to set mode automatically based on the first few
chars of the file (all binaries seem to start with <code>^?ELF</code>), I&#39;d like
to know that as well. Happy hacking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/07/29/brand-new-swiper-all/">
        Swipe all the files!
      </a>
    </h1>

    <span class="post-date">29 Jul 2016</span>

    <p>If you&#39;ve ever tried the <code>swiper-all</code> from
<a href="https://github.com/abo-abo/swiper">swiper</a>, forget everything about
it.  The command was super-awkward, since it had to parse all your
open files before giving you a chance enter anything, resulting in
dozens of seconds before the prompt.</p>

<p>Recently, I&#39;ve had some time to examine and improve it and the result
looks very promising. The new command is now async, which means
there&#39;s no delay before the prompt comes up. Here&#39;s a result I got
with no delay while having around 50 buffers open:</p>

<p><img src="/download/swiper-all.png" alt="swiper-all.png"></p>

<p>The shortcut I&#39;m using:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span></span><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c u&quot;</span><span class="p">)</span> <span class="ss">&#39;swiper-all</span><span class="p">)</span>
</code></pre></div>
<p>For efficiency&#39;s sake a small trade off had to be made: the line
numbers are no longer displayed. This actually results in an advantage
that you can select different candidates on the same line.</p>

<p>There are still a few things I plan to try for the new command, like
adding file-less buffers, caching for incremental regexes and maybe
even newlines in wild cards, but even now it seems very usable. So
give it a try, enjoy and happy hacking!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
