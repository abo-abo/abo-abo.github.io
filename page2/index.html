<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      (or emacs &middot; irrelevant)
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/octicons.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- <div class="sidebar-item"> -->
  <!--   <p>unused</p> -->
  <!-- </div> -->

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <div id="github" class="sidebar-nav-item">
      <button type="button"
              class="btn btn-info"
              data-toggle="collapse"
              data-target="#github-projects">
        <span class="octicon octicon-mark-github"></span> My Emacs Projects
      </button>
      <div id="github-projects" class="collapse">
        <ul style="margin-bottom:0em;">
          <li>
            <a href="https://github.com/abo-abo/lispy">lispy</a>
            <p>vi-like Paredit</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/worf">worf</a>
            <p>vi-like bindings for org-mode</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-window">ace-window</a>
            <p>switch windows with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/ace-link">ace-link</a>
            <p>follow links with <code>ace-jump-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/function-args">function-args</a>
            <p>enhance <code>CEDET</code> for C++</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/helm-make">helm-make</a>
            <p>select a Makefile target with <code>helm</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/make-it-so">make-it-so</a>
            <p>transform files with Makefile recipes</p>
          </li>
          <li>
            <a href="https://github.com/abo-abo/org-download">org-download</a>
            <p>drag-and-drop images to <code>org-mode</code></p>
          </li>
          <li>
            <a href="https://github.com/abo-abo?tab=repositories">
              <span class="octicon octicon-octoface"></span>
              and more
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

  <div class="sidebar-item">
    <p>
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License"
             style="border-width:0;opacity: 0.3;"
             src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"/>
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">(or emacs</a>
            <small>irrelevant)</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/23/ivy-multiaction/">
        New Ivy multi-action exit
      </a>
    </h1>

    <span class="post-date">23 Jul 2015</span>

    <p>So many Emacs commands and bindings, but little time to learn them
all.  That&#39;s why many-in-one solutions like
<a href="https://github.com/abo-abo/hydra">hydra</a> are often a good deal: you
only remember the base binding, and get more info along the way if you
get lost.</p>

<p>I&#39;ve wanted to optimize this approach when it comes to completion as
well.  In
<a href="http://oremacs.com/2015/06/08/describe-variable-tip/">last month&#39;s post</a>
I described how you can get help / jump to definition / jump to info
for the current <kbd>F1 v</kbd> (<code>counsel-describe-variable</code>)
candidate with <kbd>C-m</kbd> / <kbd>C-.</kbd> / <kbd>C-,</kbd>.
While that approach can be viable, it has a few problems. The first
problem is that it&#39;s not discoverable: you may be using <kbd>C-m</kbd>
option for ages and not know that <kbd>C-.</kbd> and <kbd>C-,</kbd>
exist. The second problem is that it&#39;s not extensible: if you wanted
more actions, there are hardly any good bindings left in the
minibuffer to bind those actions.</p>

<p>In
<a href="http://oremacs.com/2015/07/09/counsel-rhythmbox/">a more recent post</a>,
I described a solution that alleviates both problems. When you press
<kbd>C-o</kbd>, you see how many actions are
available, and you can cycle them with <kbd>w</kbd> and
<kbd>s</kbd>. However, while discoverable, this approach is cumbersome
if you already know what you want to do. Especially cycling can&#39;t be
great when there are a lot of actions.</p>

<p>So today I&#39;ve added a new approach in addition to the previous one.
When you press <kbd>M-o</kbd> (<code>ivy-dispatching-done</code>), you get a hint
showing you which actions are available.  It&#39;s like <kbd>C-m</kbd>
(<code>ivy-done</code>), only allows you to quickly select the
action. Conveniently, the default action is bound to <kbd>o</kbd>, so
<kbd>M-o o</kbd> is equivalent to <kbd>C-m</kbd>.</p>

<p>Here&#39;s how I add one more action to the default one of <code>ivy-switch-buffer</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">ivy-set-actions</span>
 <span class="ss">&#39;ivy-switch-buffer</span>
 <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;k&quot;</span>
    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">kill-buffer</span> <span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">ivy--reset-state</span> <span class="nv">ivy-last</span><span class="p">))</span>
    <span class="s">&quot;kill&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>So now:</p>

<ul>
<li><kbd>M-o o</kbd> will still switch to selected buffer.</li>
<li><kbd>M-o k</kbd> will kill the selected buffer.</li>
</ul>

<p>If you&#39;re familiar with <code>hydra</code>, the format is the same: <code>(key cmd
hint)</code>.  This approach is very extensible: you can add actions and
bindings to commands without changing the code of the original
command. It&#39;s really fast: you&#39;re typing just one extra key to select
an action. And you&#39;ll hardly run out of keys to bind, with 25 lower
case keys at your disposal (other bindings work as well, I just think
that lower case keys are the fastest to press).</p>

<p>In case you wonder what <code>(ivy--reset-state ivy-last)</code> does, it&#39;s used
to update the list of buffers, since one of them was deleted. This
way, you can delete e.g. 4 buffers with <kbd>C-x b C-o s gggg</kbd>,
and have the buffer list update after each <kbd>g</kbd>.</p>

<h2 id="new-functionality-in-action">New functionality in action</h2>

<p>Let&#39;s look at one package that has a multitude of actions available
for each candidate - <code>projectile</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">defvar</span> <span class="nv">helm-projectile-projects-map</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">map</span> <span class="p">(</span><span class="nf">make-sparse-keymap</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">set-keymap-parent</span> <span class="nv">map</span> <span class="nv">helm-map</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">helm-projectile-define-key</span> <span class="nv">map</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-d&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">dired</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-g&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-vc</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-e&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-switch-to-eshell</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-s&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-find-files-grep</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-c&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-compile-project</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-t&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-test-project</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-r&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-run-project</span>
        <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-D&quot;</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">helm-projectile-remove-known-project</span><span class="p">)</span>
    <span class="nv">map</span><span class="p">)</span>
  <span class="s">&quot;Mapping for known projectile projects.&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Here&#39;s the basic Ivy function for selecting a project:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">ivy-switch-project</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ivy-read</span>
   <span class="s">&quot;Switch to project: &quot;</span>
   <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">projectile-project-p</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span> <span class="p">(</span><span class="nv">projectile-project-root</span><span class="p">))</span>
             <span class="p">(</span><span class="nv">projectile-relevant-known-projects</span><span class="p">))</span>
     <span class="nv">projectile-known-projects</span><span class="p">)</span>
   <span class="nb">:action</span> <span class="nf">#&#39;</span><span class="nv">projectile-switch-project-by-name</span><span class="p">))</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c m&quot;</span><span class="p">)</span> <span class="ss">&#39;ivy-switch-project</span><span class="p">)</span>
</code></pre></div>
<p>And now let&#39;s add all those actions:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">ivy-set-actions</span>
 <span class="ss">&#39;ivy-switch-project</span>
 <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;d&quot;</span> <span class="nv">dired</span> <span class="s">&quot;Open Dired in project&#39;s directory&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;v&quot;</span> <span class="nv">helm-projectile-vc</span> <span class="s">&quot;Open project root in vc-dir or magit&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;e&quot;</span> <span class="nv">helm-projectile-switch-to-eshell</span> <span class="s">&quot;Switch to Eshell&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;g&quot;</span>
    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">helm-do-grep-1</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">x</span><span class="p">)))</span>
    <span class="s">&quot;Grep in projects&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;c&quot;</span> <span class="nv">helm-projectile-compile-project</span> <span class="s">&quot;Compile project&quot;</span><span class="p">)</span>
   <span class="p">(</span><span class="s">&quot;r&quot;</span> <span class="nv">helm-projectile-remove-known-project</span> <span class="s">&quot;Remove project(s)&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>Here&#39;s what I get now after pressing <kbd>M-o</kbd>:</p>

<p><img src="/download/ivy-multiaction.png" alt="ivy-multiaction.png"></p>

<p>Looks pretty good, I think. I hope you find the new approach useful.
The multi-action exit is currently enabled by default for
<code>ivy-switch-buffer</code>, <code>counsel-locate</code> and <code>counsel-rhythmbox</code>, but you
can add actions yourself to almost any command that uses <code>ivy-read</code>.
In the rare case when <code>ivy-read</code> isn&#39;t in the tail position, you can
use <a href="http://oremacs.com/2015/07/16/callback-quit/">ivy-quit-and-run</a>
inside the added action functions.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/20/hydra-columns/">
        Easily arrange hydra into a matrix
      </a>
    </h1>

    <span class="post-date">20 Jul 2015</span>

    <h2 id="the-new-:columns-option">The new <code>:columns</code> option</h2>

<p>Today I&#39;ll introduce a pretty cool new option that you can use to
quickly create hydra docstrings arranged in a matrix.  This, of
course, was already possible before, but you had to format the matrix
by-hand like this (I cite just bit instead of the
<a href="https://github.com/abo-abo/hydra/wiki/Projectile">full code</a>, it was
cut to fit into the Jekyll code column restriction):</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-projectile</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">teal</span>
                            <span class="nb">:hint</span> <span class="no">nil</span><span class="p">)</span>
  <span class="s">&quot;</span>
<span class="s">     PROJECTILE:</span>

<span class="s">     Find File            Search/Tags</span>
<span class="s">-----------------------------------------</span>
<span class="s">_s-f_: file            _a_: ag</span>
<span class="s"> _ff_: file dwim       _g_: update gtags</span>
<span class="s"> _fd_: file curr dir   _o_: multi-occur</span>
<span class="s"> &quot;</span>
  <span class="p">(</span><span class="s">&quot;s-f&quot;</span> <span class="nv">projectile-find-file</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="nv">projectile-ag</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;ff&quot;</span> <span class="nv">projectile-find-file-dwim</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;fd&quot;</span> <span class="nv">projectile-find-file-in-directory</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;g&quot;</span> <span class="nv">ggtags-update-tags</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;o&quot;</span> <span class="nv">projectile-multi-occur</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span> <span class="s">&quot;cancel&quot;</span><span class="p">))</span>
</code></pre></div>
<p>The syntax above is still very useful if you want to arrange every
detail perfectly or need Ruby-style quoting.  But here&#39;s the new
syntax that allows to get almost the
<a href="https://github.com/abo-abo/hydra/wiki/Projectile">same docstring</a>
much easier:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defhydra</span> <span class="nv">hydra-projectile</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">blue</span>
                            <span class="nb">:columns</span> <span class="mi">4</span><span class="p">)</span>
  <span class="s">&quot;Projectile&quot;</span>
  <span class="p">(</span><span class="s">&quot;a&quot;</span> <span class="nv">projectile-ag</span> <span class="s">&quot;ag&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;b&quot;</span> <span class="nv">projectile-switch-to-buffer</span> <span class="s">&quot;switch to buffer&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;c&quot;</span> <span class="nv">projectile-invalidate-cache</span> <span class="s">&quot;cache clear&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;d&quot;</span> <span class="nv">projectile-find-dir</span> <span class="s">&quot;dir&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;s-f&quot;</span> <span class="nv">projectile-find-file</span> <span class="s">&quot;file&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;ff&quot;</span> <span class="nv">projectile-find-file-dwim</span> <span class="s">&quot;file dwim&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;fd&quot;</span> <span class="nv">projectile-find-file-in-directory</span> <span class="s">&quot;file curr dir&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;g&quot;</span> <span class="nv">ggtags-update-tags</span> <span class="s">&quot;update gtags&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;i&quot;</span> <span class="nv">projectile-ibuffer</span> <span class="s">&quot;Ibuffer&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;K&quot;</span> <span class="nv">projectile-kill-buffers</span> <span class="s">&quot;Kill all buffers&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;o&quot;</span> <span class="nv">projectile-multi-occur</span> <span class="s">&quot;multi-occur&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;p&quot;</span> <span class="nv">projectile-switch-project</span> <span class="s">&quot;switch&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;r&quot;</span> <span class="nv">projectile-recentf</span> <span class="s">&quot;recent file&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;x&quot;</span> <span class="nv">projectile-remove-known-project</span> <span class="s">&quot;remove known&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;X&quot;</span> <span class="nv">projectile-cleanup-known-projects</span> <span class="s">&quot;cleanup non-existing&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;z&quot;</span> <span class="nv">projectile-cache-current-file</span> <span class="s">&quot;cache current&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="s">&quot;q&quot;</span> <span class="no">nil</span> <span class="s">&quot;cancel&quot;</span><span class="p">))</span>
</code></pre></div>
<p>It still looks pretty good, in my opinion:</p>

<p><img src="/download/hydra-columns-projectile.png" alt="hydra-columns-projectile.png"></p>

<p>Note how all redundant information has been removed. Another advantage
is the you can easily:</p>

<ul>
<li>Add/remove heads.</li>
<li>Update head hints.</li>
<li>Change the number of columns.</li>
</ul>

<h2 id="a-bit-of-customization">A bit of customization</h2>

<p>After each change, just re-eval the <code>defhydra</code> and you&#39;re done - no
need to manually re-arrange the docstring.  Since there already is an
interface that allows you to customize the docstring very precisely, I
tried to make the new interface as automatic as possible: just specify
the number of columns and you&#39;re done. But if you want just a little
bit more customization, look at this code:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="k">defvar</span> <span class="nv">hydra-key-doc-function</span> <span class="ss">&#39;hydra-key-doc-function-default</span>
  <span class="s">&quot;The function for formatting key-doc pairs.&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hydra-key-doc-function-default</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">key-width</span> <span class="nv">doc</span> <span class="nv">doc-width</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">format</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;%%%ds: %%%ds&quot;</span> <span class="nv">key-width</span> <span class="p">(</span><span class="nf">-</span> <span class="mi">-1</span> <span class="nv">doc-width</span><span class="p">))</span>
          <span class="nv">key</span> <span class="nv">doc</span><span class="p">))</span>
</code></pre></div>
<p>So if you want to add a little space here and there, or e.g. wrap key
bindings in brackets, just clone <code>hydra-key-doc-function-default</code>,
customize it a bit and set <code>hydra-key-doc-function</code> to the new
function.</p>

<h2 id="outro">Outro</h2>

<p>If you&#39;ve been using just the plain style before and felt that you
can&#39;t fit your docstring on one line, try the new style: it&#39;s just one
line of change with respect to your old code.  And if you&#39;ve been
building the docstring by-hand, see if it&#39;s possible to transform it
to the new style: adding and removing new heads will become easier.
Thanks to <a href="https://github.com/Fuco1">@Fuco1</a> for the suggestion in
<a href="https://github.com/abo-abo/hydra/issues/140">#140</a>.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/16/callback-quit/">
        Quitting to command loop in Elisp
      </a>
    </h1>

    <span class="post-date">16 Jul 2015</span>

    <p>Today I&#39;d like to share an interesting bit of Elisp that comes up
every now and then for me.  Imagine that you have this:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">useful-command</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">do-thing-1</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">do-thing-2</span> <span class="p">(</span><span class="nf">funcall</span> <span class="nv">callback-function</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">do-thing-3</span><span class="p">))</span>
</code></pre></div>
<p>Sometimes, when you are in <code>callback-function</code>, you might want to
abandon the function that called you, <code>useful-command</code> in this case,
and call a different function, with the current context.</p>

<p>Here&#39;s what I&#39;ve come up with to do just that:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defmacro</span> <span class="nv">ivy-quit-and-run</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">body</span><span class="p">)</span>
  <span class="s">&quot;Quit the minibuffer and run BODY afterwards.&quot;</span>
  <span class="o">`</span><span class="p">(</span><span class="k">progn</span>
     <span class="p">(</span><span class="nf">put</span> <span class="ss">&#39;quit</span> <span class="ss">&#39;error-message</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
     <span class="p">(</span><span class="nv">run-at-time</span> <span class="no">nil</span> <span class="no">nil</span>
                  <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
                    <span class="p">(</span><span class="nf">put</span> <span class="ss">&#39;quit</span> <span class="ss">&#39;error-message</span> <span class="s">&quot;Quit&quot;</span><span class="p">)</span>
                    <span class="o">,@</span><span class="nv">body</span><span class="p">))</span>
     <span class="p">(</span><span class="nv">minibuffer-keyboard-quit</span><span class="p">)))</span>
</code></pre></div>
<p>To break it up into parts:</p>

<ul>
<li><p><code>minibuffer-keyboard-quit</code> will unwind the call stack all the way to
the command loop, preventing e.g.  <code>do-thing-3</code> from being
called. Note that the call stack can be as deep as you like, e.g.
<code>useful-command</code> might be called by <code>utility-command</code> etc.</p></li>
<li><p><code>run-at-time</code> with the argument <code>nil</code> will run the code as soon as
possible, which is almost exactly after we&#39;re back into the command
loop.</p></li>
<li><p>The final trick is to prevent <code>Quit</code> from being displayed in the minibuffer.</p></li>
</ul>

<h2 id="sample-application">Sample application</h2>

<p>Suppose that I&#39;ve called <code>find-file</code> when <code>ivy-mode</code> is
active. Typically, I&#39;d select a file and press <kbd>C-m</kbd> to open
it. However, sometimes I just want to see the selected file in <code>dired</code>
instead of opening it. This code is from before
<a href="http://oremacs.com/2015/07/09/counsel-rhythmbox/">ivy multi-action interface</a>,
it plainly binds a command in <code>ivy-minibuffer-map</code>:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">ivy-minibuffer-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-:&quot;</span><span class="p">)</span> <span class="ss">&#39;ivy-dired</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ivy-dired</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">ivy--directory</span>
      <span class="p">(</span><span class="nv">ivy-quit-and-run</span>
       <span class="p">(</span><span class="nv">dired</span> <span class="nv">ivy--directory</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span>
              <span class="p">(</span><span class="nf">regexp-quote</span>
               <span class="p">(</span><span class="nf">substring</span> <span class="nv">ivy--current</span> <span class="mi">0</span> <span class="mi">-1</span><span class="p">))</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">match-beginning</span> <span class="mi">0</span><span class="p">))))</span>
    <span class="p">(</span><span class="ne">user-error</span>
     <span class="s">&quot;Not completing files currently&quot;</span><span class="p">)))</span>
</code></pre></div>
<p>So at the moment when <kbd>C-:</kbd> is pressed, the call stack is:</p>

<ul>
<li><kbd>C-x C-f</kbd> called <code>find-file</code>.</li>
<li><code>find-file</code> called <code>completion-read-function</code> which is set to <code>ivy-completing-read</code>.</li>
<li><code>ivy-completing-read</code> called <code>ivy-read</code>.</li>
<li><code>ivy-read</code> called <code>read-from-minibuffer</code>.</li>
</ul>

<p>Thanks to the new macro, I can unwind all of that stuff, making sure
nothing extra will be executed that was supposed to be executed after
<code>read-from-minibuffer</code> had returned. In other words, the file will not
be opened.  Instead, a <code>dired</code> buffer will be opened, centered on the
selected candidate.</p>

<p>What I described above can actually be a pretty common scenario, you
could adapt it to <code>helm</code> or <code>avy</code> or <code>projectile</code>.  Basically to
anything that includes some form of completion (i.e. commands that
wait for input) and offers you a customizable keymap. Small
disclaimer: the above code falls into the quick-and-dirty category, I
don&#39;t recommend it if you can do something smarter instead. But if you
can&#39;t do anything smarter due to being constrained by an interface you
don&#39;t control, this macro could help you out.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/09/counsel-rhythmbox/">
        Command Rhythmbox from Emacs
      </a>
    </h1>

    <span class="post-date">09 Jul 2015</span>

    <p>I might have mentioned before that I&#39;m using GNU/Linux on all of my
computers.  The particular flavor is Ubuntu, although it shouldn&#39;t
matter much, since I can count the graphical applications that I use
at all, besides Emacs, on one hand. They are: Firefox, Evince,
Rhythmbox and VLC. Of course, as most true Emacs-ers, I strive to
reduce this number to zero. So I got quite excited when I saw
<a href="https://github.com/mrBliss/helm-rhythmbox">helm-rhythmbox</a> show up in
my package list. It works great: you can play and enqueue tracks with
completion without leaving Emacs. Big thanks to
<a href="https://github.com/mrBliss">@mrBliss</a>, and, of course, the authors
for <code>dbus.el</code> which makes interaction with D-Bus possible through
Elisp.</p>

<p>I&#39;m not as big a fan of Helm as I used to be, so I quickly implemented an Ivy equivalent:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-rhythmbox-enqueue-song</span> <span class="p">(</span><span class="nv">song</span><span class="p">)</span>
  <span class="s">&quot;Let Rhythmbox enqueue SONG.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">service</span> <span class="s">&quot;org.gnome.Rhythmbox3&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">path</span> <span class="s">&quot;/org/gnome/Rhythmbox3/PlayQueue&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">interface</span> <span class="s">&quot;org.gnome.Rhythmbox3.PlayQueue&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">dbus-call-method</span> <span class="nb">:session</span> <span class="nv">service</span> <span class="nv">path</span> <span class="nv">interface</span>
                      <span class="s">&quot;AddToQueue&quot;</span> <span class="p">(</span><span class="nv">rhythmbox-song-uri</span> <span class="nv">song</span><span class="p">))))</span>

<span class="c1">;;;###autoload</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-rhythmbox</span> <span class="p">()</span>
  <span class="s">&quot;Choose a song from the Rhythmbox library to play or enqueue.&quot;</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;helm-rhythmbox</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
    <span class="p">(</span><span class="ne">error</span> <span class="s">&quot;Please install `helm-rhythmbox&#39;&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">rhythmbox-library</span>
    <span class="p">(</span><span class="nv">rhythmbox-load-library</span><span class="p">)</span>
    <span class="p">(</span><span class="k">while</span> <span class="p">(</span><span class="nf">null</span> <span class="nv">rhythmbox-library</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">sit-for</span> <span class="mf">0.1</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;Rhythmbox: &quot;</span>
            <span class="p">(</span><span class="nv">helm-rhythmbox-candidates</span><span class="p">)</span>
            <span class="nb">:action</span>
            <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span>
              <span class="p">(</span><span class="s">&quot;Play song&quot;</span> <span class="nv">helm-rhythmbox-play-song</span><span class="p">)</span>
              <span class="p">(</span><span class="s">&quot;Enqueue song&quot;</span> <span class="nv">counsel-rhythmbox-enqueue-song</span><span class="p">))))</span>
</code></pre></div>
<p>I listed the whole code just to show how easy it is to interact with
D-Bus, and also to show-off the shiny new multi-action interface of
<code>ivy-read</code>.  Besides being discoverable via <kbd>C-o</kbd>, the
multi-action interface is extensible as well. Here&#39;s how to add a
&quot;Dequeue&quot; action without touching the original code:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">counsel-rhythmbox-dequeue-song</span> <span class="p">(</span><span class="nv">song</span><span class="p">)</span>
  <span class="s">&quot;Let Rhythmbox dequeue SONG.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">service</span> <span class="s">&quot;org.gnome.Rhythmbox3&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">path</span> <span class="s">&quot;/org/gnome/Rhythmbox3/PlayQueue&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">interface</span> <span class="s">&quot;org.gnome.Rhythmbox3.PlayQueue&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">dbus-call-method</span> <span class="nb">:session</span> <span class="nv">service</span> <span class="nv">path</span> <span class="nv">interface</span>
                      <span class="s">&quot;RemoveFromQueue&quot;</span> <span class="p">(</span><span class="nv">rhythmbox-song-uri</span> <span class="nv">song</span><span class="p">))))</span>
<span class="p">(</span><span class="nv">ivy-set-actions</span>
 <span class="ss">&#39;counsel-rhythmbox</span>
 <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;Dequeue song&quot;</span> <span class="nv">counsel-rhythmbox-dequeue-song</span><span class="p">)))</span>
</code></pre></div>
<p>Very simple, <code>counsel-rhythmbox-dequeue-song</code> is a clone of
<code>counsel-rhythmbox-enqueue-song</code> with only the method change from
<code>AddToQueue</code> to <code>RemoveFromQueue</code> (I blind-guessed the name, but there
should be a reference somewhere).  If you got tired of having a whole
three actions to choose from, you can revert to the initial two with:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">ivy-set-actions</span> <span class="ss">&#39;counsel-rhythmbox</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div>
<p>And here&#39;s how the updated <kbd>C-o</kbd> option panel now looks like:</p>

<p><img src="/download/counsel-rhythmbox.png" alt="counsel-rhythmbox.png"></p>

<p>A bit of descriptions:</p>

<ul>
<li><kbd>j</kbd> moves to the next one of the 18 current candidates.</li>
<li><kbd>k</kbd> moves to the previous candidate.</li>
<li><kbd>h</kbd> moves to the first candidate.</li>
<li><kbd>l</kbd> moves to the last candidate.</li>
<li><kbd>g</kbd> calls the current action without exiting.</li>
<li><kbd>d</kbd> calls the current action and exits.</li>
<li><kbd>s</kbd> moves to the next action.</li>
<li><kbd>w</kbd> moves to the previous action.</li>
<li><kbd>i</kbd> and <kbd>C-o</kbd> close the options panel without exiting.</li>
<li><kbd>o</kbd> closes the panel and exits.</li>
</ul>

<p>Similarly to <code>hydra</code>, each action has a short docstring, like <code>&quot;Play
song&quot;</code> that should describe what it does.  Here are a few usage
scenarios:</p>

<ul>
<li>If I wanted to play the first song and enqueue the third and the
sixth and exit the minibuffer, I would press <kbd>gsjjgjjjd</kbd>.</li>
<li>If I wanted to play the third and enqueue all the following, I would
press <kbd>jjgsjcjjjjjjjjjjjo</kbd>. The many <kbd>j</kbd> is just
me holding <kbd>j</kbd> until the selection reaches the end, then I
simply exit without doing anything else by pressing <kbd>o</kbd>.
The way <kbd>c</kbd> works is that it toggles the &quot;calling&quot; state -
a state where the current action is called whenever a different
candidate is selected.</li>
</ul>

<p>Almost forgot, if this little intro got you excited, the packages that you should install from MELPA are: <code>helm-rhythmbox</code> and <code>counsel</code>.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/07/07/hydra-resume/">
        Pause or resume the current Hydra
      </a>
    </h1>

    <span class="post-date">07 Jul 2015</span>

    <p>Today I&#39;d like to highlight a generic command recently added to
<a href="https://github.com/abo-abo/hydra">hydra</a>.  It&#39;s kind of cute, and
maybe something that you didn&#39;t even know you wanted.  Basically, the
<code>hydra-pause-resume</code> command allows to pause and resume the current
hydra with one key. And it works for all hydras at once, without any
extra configuration. All you have to do is to bind it globally to
whatever you like, for example:</p>
<div class="highlight"><pre><code class="language-elisp" data-lang="elisp"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-M-k&quot;</span><span class="p">)</span> <span class="ss">&#39;hydra-pause-resume</span><span class="p">)</span>
</code></pre></div>
<p>What it does:</p>

<ul>
<li>If a hydra is active, deactivate and push it on the stack.</li>
<li>If no hydra is active, pop one from the stack and call it.</li>
<li>If the stack is empty, call the last hydra.</li>
</ul>

<p>Personally, I haven&#39;t found too much use from the stack - resuming the
last one is enough for me. But the stack comes at no extra cost, and
might be useful to someone.</p>

<blockquote>
<p>If, for example, you have 2 hydras on the stack, how to resume the
older one?</p>
</blockquote>

<p>The way stacks work, you simply have to go through all elements one by one. So that&#39;s:</p>

<ol>
<li><kbd>C-M-k</kbd> to resume the newer one.</li>
<li>Quit the current one with the appropriate shortcut, only not with <kbd>C-M-k</kbd>, since that would just put it back on the stack.</li>
<li><kbd>C-M-k</kbd> to resume the only one remaining on the stack - the older one.</li>
</ol>

<p>Thanks to <a href="https://github.com/QiangF">@QiangF</a> for the suggestion in <a href="https://github.com/abo-abo/hydra/issues/135">#135</a>.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
